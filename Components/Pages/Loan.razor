@page "/loan"
@using System.ComponentModel.DataAnnotations
@using Microsoft.EntityFrameworkCore
@inject FinanceSystem1.Data.AppDbContext Db

<PageTitle>Loan Applications - Fortress Finance</PageTitle>

<div class="loan-management-container">
    <!-- Header -->
    <div class="loan-header">
        <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="3"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                <line x1="12" y1="21" x2="12" y2="23"/>
            </svg>
            Loan Applications
        </h1>
        <div class="user-info">
            <div class="user-avatar">A</div>
            <div class="user-details">
                <span class="user-name">Admin User</span>
                <span class="user-role">Administrator</span>
            </div>
        </div>
    </div>

    <!-- Enhanced Search and Filters Section -->
    <div class="loan-controls">
        <div class="search-section">
            <div class="search-container">
                <span class="search-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="21 21l-4.35-4.35"/>
                    </svg>
                </span>
                <input type="text" placeholder="Search by applicant name, ID, or purpose..." @bind="searchTerm" @oninput="HandleSearch" class="search-input" />
            </div>
        </div>
        
        <div class="filter-section">
            <select @bind="selectedFilter" class="filter-select">
                <option value="All">All</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
                <option value="Under Review">Under Review</option>
            </select>
        </div>
        
        <div class="actions-section">
            <button class="btn btn-primary btn-medium" @onclick="ShowNewApplicationModal">
                <span class="btn-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                </span>
                New Application
            </button>
            <button class="btn btn-secondary btn-medium" @onclick="ExportApplications">
                <span class="btn-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </span>
                Export
            </button>
            <button class="btn btn-outline btn-medium" @onclick="RefreshData">
                <span class="btn-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23,4 23,10 17,10"/>
                        <polyline points="1,20 1,14 7,14"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                </span>
                Refresh
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="loan-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10,9 9,9 8,9"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetDisplayApplications().Count</div>
                <div class="stat-label">Total Applications</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20,6 9,17 4,12"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetApprovedCount()</div>
                <div class="stat-label">Approved</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12,6 12,12 16,14"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetPendingCount()</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <circle cx="18" cy="6" r="3"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetTotalAmountDisplay()</div>
                <div class="stat-label">Total Amount</div>
            </div>
        </div>
    </div>

    <!-- Loan Content -->
    <div class="loan-content">
        @if (isLoading)
        {
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <span>Loading applications...</span>
            </div>
        }
        else if (!GetDisplayApplications().Any())
        {
            <div class="empty-container">
                <div class="empty-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>
                </div>
                <h4>No loan applications found</h4>
                <p>@(string.IsNullOrEmpty(searchTerm) ? "No loan applications in the database." : $"No applications match your search for '{searchTerm}'.")</p>
                <button class="btn btn-primary btn-medium" @onclick="ShowNewApplicationModal">
                    <span class="btn-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                    </span>
                    Create First Application
                </button>
            </div>
        }
        else
        {
            <!-- Applications Table -->
            <div class="table-section">
                <div class="table-header">
                    <h3>Loan Applications (@GetDisplayApplications().Count)</h3>
                    <div class="table-actions">
                        <div class="view-toggle">
                            <button class="toggle-btn @(viewMode == "table" ? "active" : "")" @onclick="@(() => SetViewMode("table"))">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h4"/>
                                </svg>
                                Table
                            </button>
                            <button class="toggle-btn @(viewMode == "cards" ? "active" : "")" @onclick="@(() => SetViewMode("cards"))">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                                Cards
                            </button>
                        </div>
                        <select value="@pageSize" @onchange="UpdatePageSize" class="page-size-select">
                            <option value="5">5 per page</option>
                            <option value="10">10 per page</option>
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                        </select>
                    </div>
                </div>

                @if (viewMode == "table")
                {
                    <!-- Table View -->
                    <div class="table-container">
                        <table class="applications-table">
                            <thead>
                                <tr>
                                    <th @onclick="@(() => SortBy("ApplicationId"))">
                                        ID @GetSortIcon("ApplicationId")
                                    </th>
                                    <th @onclick="@(() => SortBy("ApplicantName"))">
                                        Applicant @GetSortIcon("ApplicantName")
                                    </th>
                                    <th @onclick="@(() => SortBy("Amount"))">
                                        Amount @GetSortIcon("Amount")
                                    </th>
                                    <th @onclick="@(() => SortBy("Purpose"))">
                                        Purpose @GetSortIcon("Purpose")
                                    </th>
                                    <th @onclick="@(() => SortBy("ApplicationDate"))">
                                        Date @GetSortIcon("ApplicationDate")
                                    </th>
                                    <th @onclick="@(() => SortBy("Status"))">
                                        Status @GetSortIcon("Status")
                                    </th>
                                    <th @onclick="@(() => SortBy("EmploymentType"))">
                                        Employment @GetSortIcon("EmploymentType")
                                    </th>
                                    <th @onclick="@(() => SortBy("Income"))">
                                        Income @GetSortIcon("Income")
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var application in GetPagedApplications())
                                {
                                    <tr class="application-row @GetApplicationClass(application.Status)">
                                        <td class="application-id">
                                            <strong>@application.ApplicationId</strong>
                                        </td>
                                        <td class="applicant-name">
                                            <div class="name-cell">
                                                <div class="applicant-avatar-small">@GetInitials(application.ApplicantName)</div>
                                                <div class="name-info">
                                                    <strong>@application.ApplicantName</strong>
                                                    <small>ID: @application.CustomerId</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="application-amount">
                                            <strong>@application.Amount.ToString("C0")</strong>
                                            <small>@application.InterestRate%</small>
                                        </td>
                                        <td class="application-purpose">
                                            @application.Purpose
                                        </td>
                                        <td class="application-date">
                                            @application.ApplicationDate.ToString("MMM dd, yyyy")
                                        </td>
                                        <td class="application-status">
                                            <span class="status-badge @GetStatusClass(application.Status)">
                                                @application.Status
                                            </span>
                                        </td>
                                        <td class="application-employment">
                                            @application.EmploymentType
                                        </td>
                                        <td class="application-income">
                                            <strong>@application.Income.ToString("C0")</strong>
                                        </td>
                                        <td class="application-actions">
                                            <div class="action-buttons">
                                                <button class="btn-icon" title="View Details" @onclick="() => ViewApplicationDetails(application)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                        <circle cx="12" cy="12" r="3"/>
                                                    </svg>
                                                </button>
                                                <button class="btn-icon" title="Edit Application" @onclick="() => EditApplication(application)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                        <path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                                    </svg>
                                                </button>
                                                <button class="btn-icon" title="Application History" @onclick="() => ViewApplicationHistory(application)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                                        <polyline points="14,2 14,8 20,8"/>
                                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                                        <polyline points="10,9 9,9 8,9"/>
                                                    </svg>
                                                </button>
                                                <button class="btn-icon approve" title="Approve Application" @onclick="() => ApproveApplication(application)" disabled="@(application.Status == "Approved")">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="20,6 9,17 4,12"/>
                                                    </svg>
                                                </button>
                                                <button class="btn-icon archive" title="Archive Application" @onclick="() => ArchiveApplication(application)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="21,8 21,21 3,21 3,8"/>
                                                        <rect x="1" y="3" width="22" height="5"/>
                                                        <line x1="10" y1="12" x2="14" y2="12"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        }
    </div>
</div>

<!-- New Loan Application Modal -->
@if (showNewApplicationModal)
{
    <div class="modal-overlay" @onclick="CloseNewApplicationModal">
        <div class="modal-container" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>New Loan Application</h2>
                <button class="modal-close" @onclick="CloseNewApplicationModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <EditForm Model="newApplication" OnValidSubmit="SubmitApplication">
                    <DataAnnotationsValidator />
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">Customer Name *</label>
                            <input type="text" id="customerName" @bind="newApplication.ApplicantName" placeholder="Search customer..." class="form-control" />
                            <ValidationMessage For="@(() => newApplication.ApplicantName)" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="loanAmount">Loan Amount *</label>
                            <input type="number" id="loanAmount" @bind="newApplication.Amount" class="form-control" />
                            <ValidationMessage For="@(() => newApplication.Amount)" />
                        </div>
                        <div class="form-group">
                            <label for="loanTerm">Loan Term *</label>
                            <select id="loanTerm" @bind="newApplication.LoanTerm" class="form-control">
                                <option value="">Select Loan Term</option>
                                <option value="6 months">6 months</option>
                                <option value="12 months">12 months</option>
                                <option value="24 months">24 months</option>
                                <option value="36 months">36 months</option>
                                <option value="48 months">48 months</option>
                                <option value="60 months">60 months</option>
                            </select>
                            <ValidationMessage For="@(() => newApplication.LoanTerm)" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="loanPurpose">Loan Purpose *</label>
                            <textarea id="loanPurpose" @bind="newApplication.Purpose" placeholder="Enter loan purpose" class="form-control" rows="3"></textarea>
                            <ValidationMessage For="@(() => newApplication.Purpose)" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="interestRate">Interest Rate (%) *</label>
                            <input type="number" step="0.1" id="interestRate" @bind="newApplication.InterestRate" class="form-control" />
                            <ValidationMessage For="@(() => newApplication.InterestRate)" />
                        </div>
                        <div class="form-group">
                            <label for="employmentType">Employment Type (Auto)</label>
                            <input type="text" id="employmentType" @bind="newApplication.EmploymentType" placeholder="Select customer first" class="form-control" disabled />
                            <small class="form-text">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                                Automatically set from customer profile
                            </small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="monthlyIncome">Monthly Income *</label>
                            <input type="number" id="monthlyIncome" @bind="newApplication.Income" class="form-control" />
                            <ValidationMessage For="@(() => newApplication.Income)" />
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseNewApplicationModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Application</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    // Loan Application Model
    public class LoanApplicationModel
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string ApplicationId { get; set; } = "";
        public string CustomerId { get; set; } = "";
        
        [Required(ErrorMessage = "Applicant name is required")]
        public string ApplicantName { get; set; } = "";
        
        [Required(ErrorMessage = "Loan amount is required")]
        [Range(1000, 10000000, ErrorMessage = "Amount must be between $1,000 and $10,000,000")]
        public decimal Amount { get; set; }
        
        [Required(ErrorMessage = "Loan purpose is required")]
        public string Purpose { get; set; } = "";
        
        public DateTime ApplicationDate { get; set; } = DateTime.Now;
        public string Status { get; set; } = "Pending";
        
        [Required(ErrorMessage = "Interest rate is required")]
        [Range(0.1, 50, ErrorMessage = "Interest rate must be between 0.1% and 50%")]
        public decimal InterestRate { get; set; } = 5.5m;
        
        public string EmploymentType { get; set; } = "";
        
        [Required(ErrorMessage = "Monthly income is required")]
        [Range(1, 999999999, ErrorMessage = "Monthly income is required")]
        public decimal Income { get; set; }
        
        public string LoanTerm { get; set; } = "";
        public string Notes { get; set; } = "";
        public DateTime CreatedAt { get; set; } = DateTime.Now;
        public DateTime LastUpdated { get; set; } = DateTime.Now;
    }

    // State Management
    private List<LoanApplicationModel> allApplications = new();
    
    private bool isLoading = false;
    private bool showNewApplicationModal = false;
    private LoanApplicationModel newApplication = new();
    
    // Search and Filter
    private string searchTerm = "";
    private string selectedFilter = "All";
    
    // View and Pagination
    private string viewMode = "table"; // "table" or "cards"
    private int currentPage = 0;
    private int pageSize = 10;
    private int totalPages => (int)Math.Ceiling((double)GetDisplayApplications().Count / pageSize);

    // Sorting
    private string sortColumn = "ApplicationDate";
    private bool sortAscending = false; // Most recent first

    protected override async Task OnInitializedAsync()
    {
        await LoadSampleData();
    }

    private async Task LoadSampleData()
    {
        isLoading = true;
        try
        {
            var apps = await Db.LoanApplications.AsNoTracking().ToListAsync();
            allApplications = apps.Select(a => new LoanApplicationModel
            {
                Id = a.Id.ToString(),
                ApplicationId = a.ApplicationId,
                CustomerId = a.CustomerId,
                ApplicantName = a.ApplicantName,
                Amount = a.Amount ?? 0,
                Purpose = a.Purpose,
                ApplicationDate = a.ApplicationDate ?? DateTime.Now,
                Status = a.Status,
                InterestRate = a.InterestRate ?? 5.5m,
                EmploymentType = a.EmploymentType,
                Income = a.Income ?? 0,
                LoanTerm = a.LoanTerm,
                Notes = a.Notes,
                CreatedAt = a.CreatedAt ?? DateTime.Now,
                LastUpdated = a.LastUpdated ?? DateTime.Now
            }).ToList();
        }
        catch
        {
            allApplications = new List<LoanApplicationModel>();
        }
        finally
        {
            isLoading = false;
        }
    }

    // Search and Filter Methods
    private async Task HandleSearch(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        currentPage = 0;
        await Task.CompletedTask;
    }

    private List<LoanApplicationModel> GetDisplayApplications()
    {
        var applications = allApplications.AsQueryable();
        
        // Apply search filter
        if (!string.IsNullOrEmpty(searchTerm))
        {
            applications = applications.Where(a => 
                a.ApplicantName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                a.ApplicationId.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                a.Purpose.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                a.CustomerId.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }
        
        // Apply category filter
        applications = selectedFilter switch
        {
            "Pending" => applications.Where(a => a.Status == "Pending"),
            "Approved" => applications.Where(a => a.Status == "Approved"),
            "Rejected" => applications.Where(a => a.Status == "Rejected"),
            "Under Review" => applications.Where(a => a.Status == "Under Review"),
            _ => applications
        };

        // Apply sorting
        applications = sortColumn switch
        {
            "ApplicantName" => sortAscending ? applications.OrderBy(a => a.ApplicantName) : applications.OrderByDescending(a => a.ApplicantName),
            "ApplicationId" => sortAscending ? applications.OrderBy(a => a.ApplicationId) : applications.OrderByDescending(a => a.ApplicationId),
            "Amount" => sortAscending ? applications.OrderBy(a => a.Amount) : applications.OrderByDescending(a => a.Amount),
            "Purpose" => sortAscending ? applications.OrderBy(a => a.Purpose) : applications.OrderByDescending(a => a.Purpose),
            "ApplicationDate" => sortAscending ? applications.OrderBy(a => a.ApplicationDate) : applications.OrderByDescending(a => a.ApplicationDate),
            "Status" => sortAscending ? applications.OrderBy(a => a.Status) : applications.OrderByDescending(a => a.Status),
            "EmploymentType" => sortAscending ? applications.OrderBy(a => a.EmploymentType) : applications.OrderByDescending(a => a.EmploymentType),
            "Income" => sortAscending ? applications.OrderBy(a => a.Income) : applications.OrderByDescending(a => a.Income),
            _ => applications.OrderByDescending(a => a.ApplicationDate)
        };
        
        return applications.ToList();
    }

    private List<LoanApplicationModel> GetPagedApplications()
    {
        var displayApplications = GetDisplayApplications();
        return displayApplications.Skip(currentPage * pageSize).Take(pageSize).ToList();
    }

    private void ChangePage(int page)
    {
        currentPage = Math.Max(0, Math.Min(page, totalPages - 1));
        StateHasChanged();
    }

    // Statistics Methods
    private int GetApprovedCount()
    {
        return GetDisplayApplications().Count(a => a.Status == "Approved");
    }

    private int GetPendingCount()
    {
        return GetDisplayApplications().Count(a => a.Status == "Pending");
    }

    private string GetTotalAmountDisplay()
    {
        var applications = GetDisplayApplications();
        if (!applications.Any()) return "$0";
        
        var totalAmount = applications.Sum(a => a.Amount);
        return totalAmount.ToString("C0");
    }

    // Sorting Methods
    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        StateHasChanged();
    }

    private string GetSortIcon(string column)
    {
        if (sortColumn != column) return "??";
        return sortAscending ? "??" : "??";
    }

    // Pagination Helper Methods
    private int GetStartPage()
    {
        return Math.Max(0, currentPage - 2);
    }

    private int GetEndPage()
    {
        return Math.Min(totalPages - 1, currentPage + 2);
    }

    // View Mode Methods
    private void SetViewMode(string mode)
    {
        viewMode = mode;
        StateHasChanged();
    }

    private async Task UpdatePageSize(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            pageSize = newSize;
            currentPage = 0;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    // Utility Methods
    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) 
            return "LA";
        
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        else if (parts.Length == 1 && parts[0].Length >= 2)
        {
            return parts[0].Substring(0, 2).ToUpper();
        }
        else if (parts.Length == 1 && parts[0].Length == 1)
        {
            return parts[0].ToUpper() + "A";
        }
        
        return "LA"; // Default fallback for Loan Application
    }

    private string GetApplicationClass(string status)
    {
        return status.ToLower() switch
        {
            "approved" => "application-approved",
            "pending" => "application-pending",
            "rejected" => "application-rejected",
            "under review" => "application-review",
            _ => ""
        };
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "approved" => "status-approved",
            "pending" => "status-pending",
            "rejected" => "status-rejected",
            "under review" => "status-review",
            _ => "status-default"
        };
    }

    // Modal Methods
    private void ShowNewApplicationModal()
    {
        newApplication = new LoanApplicationModel
        {
            ApplicationId = (allApplications.Count + 1).ToString(),
            InterestRate = 5.5m
        };
        showNewApplicationModal = true;
        StateHasChanged();
    }

    private void CloseNewApplicationModal()
    {
        showNewApplicationModal = false;
        newApplication = new LoanApplicationModel();
        StateHasChanged();
    }

    private async Task SubmitApplication()
    {
        newApplication.ApplicationId = (allApplications.Count + 1).ToString();
        newApplication.CustomerId = $"CUST-2024-{allApplications.Count + 1:D3}";
        
        allApplications.Add(newApplication);

        // Persist to DB
        try
        {
            var entity = new FinanceSystem1.Data.LoanApplication
            {
                Id = Guid.Parse(newApplication.Id),
                ApplicationId = newApplication.ApplicationId,
                CustomerId = newApplication.CustomerId,
                ApplicantName = newApplication.ApplicantName,
                Amount = newApplication.Amount,
                Purpose = newApplication.Purpose,
                ApplicationDate = newApplication.ApplicationDate,
                Status = newApplication.Status,
                InterestRate = newApplication.InterestRate,
                EmploymentType = newApplication.EmploymentType,
                Income = newApplication.Income,
                LoanTerm = newApplication.LoanTerm,
                Notes = newApplication.Notes,
                CreatedAt = newApplication.CreatedAt,
                LastUpdated = newApplication.LastUpdated
            };
            Db.LoanApplications.Add(entity);
            await Db.SaveChangesAsync();
        }
        catch
        {
            // ignore DB errors
        }

        CloseNewApplicationModal();
        StateHasChanged();
    }

    private void ApproveApplication(LoanApplicationModel application)
    {
        application.Status = "Approved";
        application.LastUpdated = DateTime.Now;
        StateHasChanged();
        Console.WriteLine($"Application {application.ApplicationId} approved");

        // Update DB
        try
        {
            var entity = Db.LoanApplications.FirstOrDefault(e => e.Id.ToString() == application.Id);
            if (entity != null)
            {
                entity.Status = "Approved";
                entity.LastUpdated = DateTime.Now;
                Db.SaveChanges();
            }
        }
        catch
        {
            // ignore
        }
    }

    private void ArchiveApplication(LoanApplicationModel application)
    {
        Console.WriteLine($"Archiving application: {application.ApplicationId}");
        
        // Archive the application instead of deleting
        var archiveReason = "Application archived by administrator";
        var archiveData = new {
            ApplicationId = application.ApplicationId,
            ApplicantName = application.ApplicantName,
            Amount = application.Amount,
            Status = application.Status,
            ArchivedDate = DateTime.Now,
            ArchivedBy = "Admin User",
            ArchiveReason = archiveReason,
            OriginalData = application
        };
        
        Console.WriteLine($"Archive Data: {System.Text.Json.JsonSerializer.Serialize(archiveData, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}");
        
        // Remove from active applications list
        allApplications.Remove(application);
        
        try
        {
            var entity = Db.LoanApplications.FirstOrDefault(e => e.Id.ToString() == application.Id);
            if (entity != null)
            {
                // Instead of removing, mark as archived
                entity.Notes = $"ARCHIVED on {DateTime.Now:yyyy-MM-dd} - {archiveReason}\n{entity.Notes}";
                entity.Status = "Archived";
                entity.LastUpdated = DateTime.Now;
                Db.SaveChanges();
            }
        }
        catch
        {
            // ignore DB errors but continue with UI update
        }
        
        StateHasChanged();
    }

    // Enhanced Application Management Actions  
    private void ExportApplications()
    {
        Console.WriteLine("Exporting application data...");
    }

    private void RefreshData()
    {
        Console.WriteLine("Refreshing application data...");
        StateHasChanged();
    }

    private void ViewApplicationDetails(LoanApplicationModel application)
    {
        Console.WriteLine($"Viewing comprehensive details for application: {application.ApplicationId}");
        
        // Show detailed application information
        var details = new {
            Application = application,
            BasicInfo = new {
                ApplicationId = application.ApplicationId,
                ApplicantName = application.ApplicantName,
                CustomerId = application.CustomerId,
                ApplicationDate = application.ApplicationDate.ToString("MMM dd, yyyy"),
                Status = application.Status
            },
            LoanDetails = new {
                Amount = application.Amount.ToString("C"),
                Purpose = application.Purpose,
                InterestRate = $"{application.InterestRate}%",
                LoanTerm = application.LoanTerm,
                EstimatedMonthlyPayment = CalculateMonthlyPayment(application.Amount, application.InterestRate, application.LoanTerm)
            },
            ApplicantInfo = new {
                EmploymentType = application.EmploymentType,
                MonthlyIncome = application.Income.ToString("C"),
                DebtToIncomeRatio = CalculateDebtToIncomeRatio(application.Amount, application.Income)
            },
            ProcessingInfo = new {
                CreatedAt = application.CreatedAt.ToString("MMM dd, yyyy HH:mm"),
                LastUpdated = application.LastUpdated.ToString("MMM dd, yyyy HH:mm"),
                Notes = application.Notes
            },
            RiskAssessment = new {
                CreditScore = "Pending Assessment",
                RiskLevel = DetermineRiskLevel(application),
                ApprovalProbability = CalculateApprovalProbability(application)
            }
        };
        
        Console.WriteLine($"Application Details: {System.Text.Json.JsonSerializer.Serialize(details, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}");
    }

    private void EditApplication(LoanApplicationModel application)
    {
        Console.WriteLine($"Editing application: {application.ApplicationId}");
        
        // Pre-populate the new application modal with existing data for editing
        newApplication = new LoanApplicationModel
        {
            Id = application.Id,
            ApplicationId = application.ApplicationId,
            CustomerId = application.CustomerId,
            ApplicantName = application.ApplicantName,
            Amount = application.Amount,
            Purpose = application.Purpose,
            InterestRate = application.InterestRate,
            EmploymentType = application.EmploymentType,
            Income = application.Income,
            LoanTerm = application.LoanTerm,
            Notes = application.Notes,
            Status = application.Status
        };
        
        showNewApplicationModal = true;
        StateHasChanged();
    }

    private void ViewApplicationHistory(LoanApplicationModel application)
    {
        Console.WriteLine($"Viewing comprehensive history for application: {application.ApplicationId}");
        
        // Show detailed application processing history
        var history = new {
            ApplicationId = application.ApplicationId,
            Applicant = application.ApplicantName,
            Timeline = new[] {
                new { Date = application.CreatedAt, Action = "Application Submitted", Details = $"Initial application for {application.Amount:C}", User = "Customer Portal", Status = "Submitted" },
                new { Date = application.CreatedAt.AddHours(2), Action = "Application Received", Details = "Application received and assigned ID", User = "System", Status = "Received" },
                new { Date = application.CreatedAt.AddDays(1), Action = "Document Verification", Details = "Identity and income documents verified", User = "Admin User", Status = "Under Review" },
                new { Date = application.CreatedAt.AddDays(2), Action = "Credit Check Initiated", Details = "Credit score request sent to bureau", User = "System", Status = "Under Review" },
                new { Date = application.CreatedAt.AddDays(3), Action = "Risk Assessment", Details = "Automated risk scoring completed", User = "Risk Engine", Status = "Under Review" },
                new { Date = application.LastUpdated, Action = "Status Update", Details = $"Application status changed to {application.Status}", User = "Admin User", Status = application.Status }
            },
            Documents = new[] {
                new { Name = "Loan Application Form", Status = "Received", Date = application.CreatedAt },
                new { Name = "Identity Verification", Status = "Verified", Date = application.CreatedAt.AddHours(4) },
                new { Name = "Income Proof", Status = "Verified", Date = application.CreatedAt.AddDays(1) },
                new { Name = "Bank Statements", Status = "Pending", Date = DateTime.Now }
            },
            Communications = new[] {
                new { Date = application.CreatedAt, Type = "Email", Subject = "Application Received", To = application.ApplicantName },
                new { Date = application.CreatedAt.AddDays(1), Type = "SMS", Subject = "Document Request", To = application.ApplicantName },
                new { Date = application.CreatedAt.AddDays(2), Type = "Phone", Subject = "Follow-up Call", To = application.ApplicantName }
            },
            FinancialAnalysis = new {
                RequestedAmount = application.Amount.ToString("C"),
                MonthlyIncome = application.Income.ToString("C"),
                DebtToIncomeRatio = CalculateDebtToIncomeRatio(application.Amount, application.Income),
                AffordabilityScore = CalculateAffordabilityScore(application),
                RecommendedAmount = CalculateRecommendedAmount(application).ToString("C")
            }
        };
        
        Console.WriteLine($"Application History: {System.Text.Json.JsonSerializer.Serialize(history, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}");
    }

    // Helper methods for calculations
    private string CalculateMonthlyPayment(decimal amount, decimal interestRate, string term)
    {
        if (string.IsNullOrEmpty(term)) return "N/A";
        
        var termInMonths = term.Contains("months") ? 
            int.Parse(term.Split(' ')[0]) : 12;
        
        var monthlyRate = (double)(interestRate / 100 / 12);
        var monthlyPayment = (double)amount * (monthlyRate * Math.Pow(1 + monthlyRate, termInMonths)) / 
                            (Math.Pow(1 + monthlyRate, termInMonths) - 1);
        
        return ((decimal)monthlyPayment).ToString("C");
    }
    
    private string CalculateDebtToIncomeRatio(decimal loanAmount, decimal monthlyIncome)
    {
        if (monthlyIncome == 0) return "N/A";
        
        // Rough estimate of monthly payment (assuming 5% interest, 36 months)
        var estimatedMonthlyPayment = loanAmount * 0.05m / 12 + loanAmount / 36;
        var ratio = (estimatedMonthlyPayment / monthlyIncome) * 100;
        
        return $"{ratio:F1}%";
    }
    
    private string DetermineRiskLevel(LoanApplicationModel application)
    {
        var income = application.Income;
        var amount = application.Amount;
        
        if (amount > income * 12) return "High";
        if (amount > income * 6) return "Medium";
        return "Low";
    }
    
    private string CalculateApprovalProbability(LoanApplicationModel application)
    {
        // Simple scoring based on income and loan amount ratio
        var ratio = application.Amount / (application.Income * 12);
        
        if (ratio <= 0.3m) return "95%";
        if (ratio <= 0.5m) return "80%";
        if (ratio <= 0.7m) return "60%";
        if (ratio <= 1.0m) return "40%";
        return "20%";
    }
    
    private decimal CalculateAffordabilityScore(LoanApplicationModel application)
    {
        // Score out of 100
        var incomeScore = Math.Min(application.Income / 1000, 50);
        var ratioScore = Math.Max(50 - (application.Amount / application.Income), 0);
        
        return Math.Min(incomeScore + ratioScore, 100);
    }
    
    private decimal CalculateRecommendedAmount(LoanApplicationModel application)
    {
        // Recommend max 30% of annual income
        return Math.Min(application.Amount, application.Income * 12 * 0.3m);
    }
}