@page "/customer"
@using System.ComponentModel.DataAnnotations
@using Microsoft.EntityFrameworkCore
@using FinanceSystem1.Data
@inject FinanceSystem1.Data.AppDbContext Db

<PageTitle>Customer Management - Fortress Finance</PageTitle>

<div class="customer-management-container">
    <!-- Header -->
    <div class="customer-header">
        <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            Customer Management
        </h1>
        <div class="user-info">
            <div class="user-avatar">A</div>
            <div class="user-details">
                <span class="user-name">Admin User</span>
                <span class="user-role">Administrator</span>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(dbErrorMessage))
    {
        <div class="db-error-banner" style="background:#ffe6e6;border:1px solid #ffb3b3;padding:12px;margin:12px 0;border-radius:6px;color:#900;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <strong>Database Connection Issue</strong>
            </div>
            <div style="margin-left:28px;">
                <p style="margin:0 0 8px 0;">@dbErrorMessage</p>
                <details style="margin-top:8px;">
                    <summary style="cursor:pointer;color:#666;font-size:0.9em;">Troubleshooting Steps</summary>
                    <ul style="margin:8px 0 0 16px;font-size:0.9em;color:#666;">
                        <li>Ensure SQL Server is running</li>
                        <li>Verify connection string: <code>LAPTOP-9U7RNK0I\\SQLEXPRESS</code></li>
                        <li>Check that database 'fn_crm' exists</li>
                        <li>Run the sample data script if tables are empty</li>
                        <li>Verify Windows Authentication is working</li>
                    </ul>
                </details>
                <div style="margin-top:12px;">
                    <button class="btn btn-outline btn-small" @onclick="RefreshData" style="margin-right:8px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23,4 23,10 17,10"/>
                            <polyline points="1,20 1,14 7,14"/>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                        </svg>
                        Retry Connection
                    </button>
                    <button class="btn btn-outline btn-small" @onclick="ClearError">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Enhanced Search and Filters Section -->
    <div class="customer-controls">
        <div class="search-section">
            <div class="search-container">
                <span class="search-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="21 21l-4.35-4.35"/>
                    </svg>
                </span>
                <input type="text" placeholder="Search by name, email, or ID..." @bind="searchTerm" @oninput="HandleSearch" class="search-input" />
            </div>
        </div>
        
        <div class="filter-section">
            <select @bind="selectedFilter" class="filter-select">
                <option value="All">All</option>
                <option value="All Customers">All Customers</option>
                <option value="Employed">Employed</option>
                <option value="Unemployed">Unemployed</option>
                <option value="With Loans">With Loans</option>
            </select>
        </div>
        
        <div class="actions-section">
            <button class="btn btn-primary btn-medium" @onclick="ShowAddModal">
                <span class="btn-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <line x1="19" y1="8" x2="19" y2="14"/>
                        <line x1="22" y1="11" x2="16" y2="11"/>
                    </svg>
                </span>
                Add Customer
            </button>
            <button class="btn btn-secondary btn-medium" @onclick="ExportCustomers">
                <span class="btn-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </span>
                Export
            </button>
            <button class="btn btn-outline btn-medium" @onclick="RefreshData">
                <span class="btn-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23,4 23,10 17,10"/>
                        <polyline points="1,20 1,14 7,14"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                </span>
                Refresh
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="customer-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetDisplayCustomers().Count</div>
                <div class="stat-label">Total Customers</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                    <line x1="8" y1="21" x2="16" y2="21"/>
                    <line x1="12" y1="17" x2="12" y2="21"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetEmployedCount()</div>
                <div class="stat-label">Employed</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetLoanCustomersCount()</div>
                <div class="stat-label">With Loans</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <circle cx="18" cy="6" r="3"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetAverageIncomeDisplay()</div>
                <div class="stat-label">Avg Income</div>
            </div>
        </div>
    </div>

    <!-- Customer Content -->
    <div class="customer-content">
        @if (isLoading)
        {
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <h4 style="margin:0 0 8px 0;color:#333;">Loading Customer Data</h4>
                <p style="margin:0;color:#666;font-size:0.9em;">Connecting to database and retrieving customer records...</p>
            </div>
        }
        else if (!GetDisplayCustomers().Any())
        {
            <div class="empty-container">
                <div class="empty-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <h4>No customers found</h4>
                <p>@(string.IsNullOrEmpty(searchTerm) ? "No customers in the database." : $"No customers match your search for '{searchTerm}'.")</p>
                <button class="btn btn-primary btn-medium" @onclick="ShowAddModal">
                    <span class="btn-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <line x1="19" y1="8" x2="19" y2="14"/>
                            <line x1="22" y1="11" x2="16" y2="11"/>
                        </svg>
                    </span>
                    Add First Customer
                </button>
            </div>
        }
        else
        {
            <!-- Customer Table -->
            <div class="table-section">
                <div class="table-header">
                    <h3>Customer Records (@GetDisplayCustomers().Count)</h3>
                    <div class="table-actions">
                        <div class="view-toggle">
                            <button class="toggle-btn @(viewMode == "table" ? "active" : "")" @onclick="@(() => SetViewMode("table"))">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h4"/>
                                </svg>
                                Table
                            </button>
                            <button class="toggle-btn @(viewMode == "cards" ? "active" : "")" @onclick="@(() => SetViewMode("cards"))">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                                Cards
                            </button>
                        </div>
                        <select value="@pageSize" @onchange="UpdatePageSize" class="page-size-select">
                            <option value="5">5 per page</option>
                            <option value="10">10 per page</option>
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                        </select>
                    </div>
                </div>

                @if (viewMode == "table")
                {
                    <!-- Table View -->
                    <div class="table-container">
                        <table class="customers-table">
                            <thead>
                                <tr>
                                    <th @onclick="@(() => SortBy("CustomerId"))">
                                        ID @GetSortIcon("CustomerId")
                                    </th>
                                    <th @onclick="@(() => SortBy("Name"))">
                                        Name @GetSortIcon("Name")
                                    </th>
                                    <th @onclick="@(() => SortBy("Email"))">
                                        Email @GetSortIcon("Email")
                                    </th>
                                    <th @onclick="@(() => SortBy("Phone"))">
                                        Phone @GetSortIcon("Phone")
                                    </th>
                                    <th @onclick="@(() => SortBy("EmploymentStatus"))">
                                        Status @GetSortIcon("EmploymentStatus")
                                    </th>
                                    <th @onclick="@(() => SortBy("MonthlyIncome"))">
                                        Income @GetSortIcon("MonthlyIncome")
                                    </th>
                                    <th @onclick="@(() => SortBy("HasActiveLoans"))">
                                        Loans @GetSortIcon("HasActiveLoans")
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var customer in GetPagedCustomers())
                                {
                                    <tr class="customer-row @GetCustomerClass(customer.EmploymentStatus)">
                                        <td class="customer-id">
                                            <strong>@customer.CustomerId</strong>
                                        </td>
                                        <td class="customer-name">
                                            <div class="name-cell">
                                                <div class="customer-avatar-small">@GetInitials(customer.Name)</div>
                                                <div class="name-info">
                                                    <strong>@customer.Name</strong>
                                                    <small>@customer.Address</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="customer-email">
                                            <a href="mailto:@customer.Email">@customer.Email</a>
                                        </td>
                                        <td class="customer-phone">
                                            <a href="tel:@customer.Phone">@customer.Phone</a>
                                        </td>
                                        <td class="customer-status">
                                            <span class="status-badge @GetStatusClass(customer.EmploymentStatus)">
                                                @customer.EmploymentStatus
                                            </span>
                                        </td>
                                        <td class="customer-income">
                                            <strong>$@customer.MonthlyIncome.ToString("N0")</strong>
                                        </td>
                                        <td class="customer-loans">
                                            @if (customer.HasActiveLoans)
                                            {
                                                <span class="loan-badge active">
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <line x1="12" y1="1" x2="12" y2="3"/>
                                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                                        <line x1="12" y1="21" x2="12" y2="23"/>
                                                    </svg>
                                                    Active
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="loan-badge inactive">
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                                    </svg>
                                                    None
                                                </span>
                                            }
                                        </td>
                                        <td class="customer-actions">
                                            <div class="action-buttons">
                                                <button class="btn-icon" title="View Details" @onclick="() => ViewCustomerDetails(customer)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                        <circle cx="12" cy="12" r="3"/>
                                                    </svg>
                                                </button>
                                                <button class="btn-icon" title="Edit Customer" @onclick="() => EditCustomer(customer)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                        <path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                                    </svg>
                                                </button>
                                                <button class="btn-icon" title="Customer History" @onclick="() => ViewCustomerHistory(customer)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                                        <polyline points="14,2 14,8 20,8"/>
                                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                                        <polyline points="10,9 9,9 8,9"/>
                                                    </svg>
                                                </button>
                                                <button class="btn-icon" title="Send Email" @onclick="() => SendEmail(customer)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                                        <polyline points="22,6 12,13 2,6"/>
                                                    </svg>
                                                </button>
                                                <button class="btn-icon archive" title="Archive Customer" @onclick="() => ArchiveCustomer(customer)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="21,8 21,21 3,21 3,8"/>
                                                        <rect x="1" y="3" width="22" height="5"/>
                                                        <line x1="10" y1="12" x2="14" y2="12"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Add New Customer Modal -->
    @if (showAddCustomerModal)
    {
        <div class="modal-overlay" @onclick="CloseAddCustomerModal">
            <div class="modal-container customer-modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h2>Add New Customer</h2>
                    <button class="modal-close" @onclick="CloseAddCustomerModal">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <EditForm Model="newCustomer" OnValidSubmit="SubmitCustomer">
                        <DataAnnotationsValidator />
                        
                        <!-- Personal Information Section -->
                        <div class="form-section">
                            <h3 class="section-title">PERSONAL INFORMATION</h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">First Name *</label>
                                    <input type="text" id="firstName" @bind="newCustomer.FirstName" placeholder="Enter first name" class="form-control" />
                                    <ValidationMessage For="@(() => newCustomer.FirstName)" />
                                </div>
                                <div class="form-group">
                                    <label for="middleName">Middle Name</label>
                                    <input type="text" id="middleName" @bind="newCustomer.MiddleName" placeholder="Enter middle name" class="form-control" />
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Last Name *</label>
                                    <input type="text" id="lastName" @bind="newCustomer.LastName" placeholder="Enter last name" class="form-control" />
                                    <ValidationMessage For="@(() => newCustomer.LastName)" />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="email">Email Address *</label>
                                    <input type="email" id="email" @bind="newCustomer.Email" placeholder="Enter email address" class="form-control" />
                                    <ValidationMessage For="@(() => newCustomer.Email)" />
                                </div>
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" @bind="newCustomer.Phone" placeholder="Enter phone number" class="form-control" />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <input type="text" id="city" @bind="newCustomer.City" placeholder="Enter city" class="form-control" />
                                </div>
                                <div class="form-group">
                                    <label for="state">State/Province</label>
                                    <input type="text" id="state" @bind="newCustomer.State" placeholder="Enter state/province" class="form-control" />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="zipCode">Zip Code</label>
                                    <input type="text" id="zipCode" @bind="newCustomer.ZipCode" placeholder="Enter zip code" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <!-- ID Documents Section -->
                        <div class="form-section">
                            <h3 class="section-title">ID DOCUMENTS</h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="idType">ID Type *</label>
                                    <select id="idType" @bind="newCustomer.IdType" class="form-control">
                                        <option value="">-- Select ID Type --</option>
                                        <option value="Driver's License">Driver's License</option>
                                        <option value="State ID Card">State ID Card</option>
                                        <option value="Passport">Passport</option>
                                        <option value="National ID Card">National ID Card</option>
                                        <option value="Military ID">Military ID</option>
                                        <option value="Social Security Card">Social Security Card</option>
                                        <option value="Birth Certificate">Birth Certificate</option>
                                        <option value="Voter ID Card">Voter ID Card</option>
                                        <option value="Resident Card (Green Card)">Resident Card (Green Card)</option>
                                        <option value="Work Authorization Card">Work Authorization Card</option>
                                        <option value="Consular ID">Consular ID</option>
                                        <option value="Tribal ID">Tribal ID</option>
                                        <option value="Student ID">Student ID</option>
                                        <option value="Employee ID">Employee ID</option>
                                        <option value="Professional License">Professional License</option>
                                        <option value="Immigration Document">Immigration Document</option>
                                        <option value="Foreign Passport">Foreign Passport</option>
                                        <option value="Visa">Visa</option>
                                        <option value="Other Government ID">Other Government ID</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <ValidationMessage For="@(() => newCustomer.IdType)" />
                                </div>
                                <div class="form-group">
                                    <label for="idNumber">ID Number *</label>
                                    <input type="text" id="idNumber" @bind="newCustomer.IdNumber" placeholder="Enter ID number" class="form-control" />
                                    <ValidationMessage For="@(() => newCustomer.IdNumber)" />
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="issuingAuthority">Issuing Authority</label>
                                    <input type="text" id="issuingAuthority" @bind="newCustomer.IssuingAuthority" placeholder="Enter issuing authority (e.g., DMV, State Department)" class="form-control" />
                                </div>
                                <div class="form-group">
                                    <label for="expirationDate">Expiration Date</label>
                                    <input type="date" id="expirationDate" @bind="newCustomer.ExpirationDate" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <!-- Employment Information Section -->
                        <div class="form-section">
                            <h3 class="section-title">EMPLOYMENT INFORMATION</h3>
                            
                            <div class="form-row">
                                <div class="form-group checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" @bind="newCustomer.IsEmployed" />
                                        <span class="checkmark"></span>
                                        Employed
                                    </label>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="annualSalary">Annual Salary *</label>
                                    <input type="number" id="annualSalary" @bind="newCustomer.AnnualSalary" class="form-control" />
                                    <ValidationMessage For="@(() => newCustomer.AnnualSalary)" />
                                </div>
                                <div class="form-group">
                                    <label for="monthlyRate">Monthly Rate *</label>
                                    <input type="number" id="monthlyRate" @bind="newCustomer.MonthlyIncome" class="form-control" />
                                    <ValidationMessage For="@(() => newCustomer.MonthlyIncome)" />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="position">Position/Role *</label>
                                    <input type="text" id="position" @bind="newCustomer.Position" placeholder="Enter position/role in company" class="form-control" />
                                    <ValidationMessage For="@(() => newCustomer.Position)" />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="certificateUrl">Certificate of Employment URL</label>
                                    <input type="url" id="certificateUrl" @bind="newCustomer.CertificateUrl" placeholder="Enter certificate URL (optional)" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <!-- Teller Information Section -->
                        <div class="form-section">
                            <h3 class="section-title">TELLER INFORMATION</h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="assignedTeller">Assign Teller/Admin *</label>
                                    <select id="assignedTeller" @bind="newCustomer.AssignedTeller" class="form-control">
                                        <option value="">-- Select Teller/Admin --</option>
                                        <option value="Admin User">Admin User</option>
                                        <option value="Teller 1">Teller 1</option>
                                        <option value="Teller 2">Teller 2</option>
                                        <option value="Manager">Manager</option>
                                    </select>
                                    <ValidationMessage For="@(() => newCustomer.AssignedTeller)" />
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseAddCustomerModal">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                </svg>
                                Save Customer
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    }

</div>

@code {
    // Enhanced Customer Model for Add Modal
    public class NewCustomerModel
    {
        [Required(ErrorMessage = "First name is required")]
        public string FirstName { get; set; } = "";
        
        public string MiddleName { get; set; } = "";
        
        [Required(ErrorMessage = "Last name is required")]
        public string LastName { get; set; } = "";
        
        [Required(ErrorMessage = "Email address is required")]
        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string Email { get; set; } = "";
        
        public string Phone { get; set; } = "";
        public string City { get; set; } = "";
        public string State { get; set; } = "";
        public string ZipCode { get; set; } = "";
        
        [Required(ErrorMessage = "ID type is required")]
        public string IdType { get; set; } = "";
        
        [Required(ErrorMessage = "ID number is required")]
        public string IdNumber { get; set; } = "";
        
        public string IssuingAuthority { get; set; } = "";
        public DateTime? ExpirationDate { get; set; }
        
        public bool IsEmployed { get; set; } = true;
        
        [Required(ErrorMessage = "Annual salary is required")]
        [Range(0, double.MaxValue, ErrorMessage = "Annual salary must be a positive number")]
        public decimal AnnualSalary { get; set; }
        
        [Required(ErrorMessage = "Monthly income is required")]
        [Range(0, double.MaxValue, ErrorMessage = "Monthly income must be a positive number")]
        public decimal MonthlyIncome { get; set; }
        
        [Required(ErrorMessage = "Position is required")]
        public string Position { get; set; } = "";
        
        public string CertificateUrl { get; set; } = "";
        
        [Required(ErrorMessage = "Teller assignment is required")]
        public string AssignedTeller { get; set; } = "";
        
        // Helper property to get full name
        public string FullName => $"{FirstName} {MiddleName} {LastName}".Trim().Replace("  ", " ");
        
        // Helper property to get full address
        public string FullAddress => $"{City}, {State} {ZipCode}".Trim().TrimStart(',').Trim();
    }

    // Customer Model
    public class CustomerModel
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string CustomerId { get; set; } = "";
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Phone { get; set; } = "";
        public string Address { get; set; } = "";
        public string EmploymentStatus { get; set; } = "";
        public decimal MonthlyIncome { get; set; }
        public DateTime? DateOfBirth { get; set; }
        public bool HasActiveLoans { get; set; } = false;
        public string Notes { get; set; } = "";
        public DateTime CreatedAt { get; set; } = DateTime.Now;
        public DateTime LastUpdated { get; set; } = DateTime.Now;
        
        // Additional fields from the new customer form
        public string IdType { get; set; } = "";
        public string IdNumber { get; set; } = "";
        public string IssuingAuthority { get; set; } = "";
        public DateTime? ExpirationDate { get; set; }
        public decimal AnnualSalary { get; set; }
        public string Position { get; set; } = "";
        public string CertificateUrl { get; set; } = "";
        public string AssignedTeller { get; set; } = "";
    }

    // State Management
    private List<CustomerModel> allCustomers = new();
    
    private bool isLoading = false;
    private bool showAddCustomerModal = false;
    private NewCustomerModel newCustomer = new();
    
    // Search and Filter
    private string searchTerm = "";
    private string selectedFilter = "All";
    
    // View and Pagination
    private string viewMode = "table"; // "table" or "cards"
    private int currentPage = 0;
    private int pageSize = 10;
    private int totalPages => (int)Math.Ceiling((double)GetDisplayCustomers().Count / pageSize);

    // Sorting
    private string sortColumn = "Name";
    private bool sortAscending = true;

    private string dbErrorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomerData();
    }

    private async Task LoadCustomerData()
    {
        isLoading = true;
        dbErrorMessage = string.Empty;
        StateHasChanged();
        
        try
        {
            // Test database connectivity first
            Console.WriteLine("Testing database connectivity...");
            
            var canConnect = await TestDatabaseConnection();
            if (!canConnect)
            {
                Console.WriteLine("Database connection failed - using fallback data");
                allCustomers = new List<CustomerModel>();
                return;
            }

            Console.WriteLine("Database connected successfully, loading customers...");
            
            // Load customers from database
            var customers = await Db.Customers
                .AsNoTracking()
                .OrderBy(c => c.Name)
                .ToListAsync();
            
            Console.WriteLine($"Loaded {customers.Count} customers from database");
            
            allCustomers = customers.Select(c => new CustomerModel
            {
                Id = c.Id.ToString(),
                CustomerId = c.CustomerId ?? "",
                Name = c.Name ?? "",
                Email = c.Email ?? "",
                Phone = c.Phone ?? "",
                Address = c.Address ?? "",
                EmploymentStatus = c.EmploymentStatus ?? "Unknown",
                MonthlyIncome = c.MonthlyIncome ?? 0m,
                DateOfBirth = c.DateOfBirth,
                HasActiveLoans = c.HasActiveLoans ?? false,
                Notes = c.Notes ?? "",
                CreatedAt = c.CreatedAt ?? DateTime.Now,
                LastUpdated = c.LastUpdated ?? DateTime.Now,
                IdType = c.IdType ?? "",
                IdNumber = c.IdNumber ?? "",
                IssuingAuthority = c.IssuingAuthority ?? "",
                ExpirationDate = c.ExpirationDate,
                AnnualSalary = c.AnnualSalary ?? 0m,
                Position = c.Position ?? "",
                CertificateUrl = c.CertificateUrl ?? "",
                AssignedTeller = c.AssignedTeller ?? ""
            }).ToList();
            
            Console.WriteLine($"Successfully mapped {allCustomers.Count} customers");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading customers: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            
            if (ex.InnerException != null)
            {
                Console.WriteLine($"Inner exception: {ex.InnerException.Message}");
            }
            
            dbErrorMessage = $"Failed to load customers: {ex.Message}";
            allCustomers = new List<CustomerModel>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task<bool> TestDatabaseConnection()
    {
        try
        {
            Console.WriteLine("Testing database connection...");
            var canConnect = await Db.Database.CanConnectAsync();
            Console.WriteLine($"Can connect to database: {canConnect}");
            
            if (canConnect)
            {
                // Test if tables exist by trying a simple query
                var count = await Db.Customers.CountAsync();
                Console.WriteLine($"Customer table contains {count} records");
                return true;
            }
            
            dbErrorMessage = "Cannot connect to database. Please check your connection string and ensure SQL Server is running.";
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Database connection test failed: {ex.Message}");
            dbErrorMessage = $"Database connection error: {ex.Message}";
            return false;
        }
    }

    private async Task RefreshData()
    {
        Console.WriteLine("Refreshing customer data...");
        await LoadCustomerData();
    }

    // Modal Methods
    private void ShowAddModal()
    {
        newCustomer = new NewCustomerModel();
        showAddCustomerModal = true;
        StateHasChanged();
    }

    private void CloseAddCustomerModal()
    {
        showAddCustomerModal = false;
        newCustomer = new NewCustomerModel();
        StateHasChanged();
    }

    private async Task SubmitCustomer()
    {
        try
        {
            Console.WriteLine("Submitting new customer...");
            
            // Generate new customer ID
            var existingCount = await Db.Customers.CountAsync();
            var customerId = $"CUST{(existingCount + 1):D3}";
            
            // Create new customer entity for database
            var customerEntity = new FinanceSystem1.Data.Customer
            {
                Id = Guid.NewGuid(),
                CustomerId = customerId,
                Name = newCustomer.FullName,
                Email = newCustomer.Email,
                Phone = newCustomer.Phone,
                Address = newCustomer.FullAddress,
                EmploymentStatus = newCustomer.IsEmployed ? "Employed" : "Unemployed",
                MonthlyIncome = newCustomer.MonthlyIncome,
                HasActiveLoans = false,
                IdType = newCustomer.IdType,
                IdNumber = newCustomer.IdNumber,
                IssuingAuthority = newCustomer.IssuingAuthority,
                ExpirationDate = newCustomer.ExpirationDate,
                AnnualSalary = newCustomer.AnnualSalary,
                Position = newCustomer.Position,
                CertificateUrl = newCustomer.CertificateUrl,
                AssignedTeller = newCustomer.AssignedTeller,
                Notes = $"Added by {newCustomer.AssignedTeller} on {DateTime.Now:yyyy-MM-dd HH:mm}",
                CreatedAt = DateTime.Now,
                LastUpdated = DateTime.Now
            };
            
            // Add to database
            Db.Customers.Add(customerEntity);
            await Db.SaveChangesAsync();
            
            Console.WriteLine($"Customer {customerId} saved successfully");
            
            // Reload data to include the new customer
            await LoadCustomerData();
            
            // Close modal
            CloseAddCustomerModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving customer: {ex.Message}");
            dbErrorMessage = $"Failed to save customer: {ex.Message}";
            StateHasChanged();
        }
    }

    // Search and Filter Methods
    private async Task HandleSearch(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        currentPage = 0;
        await Task.CompletedTask;
    }

    private List<CustomerModel> GetDisplayCustomers()
    {
        var customers = allCustomers.AsQueryable();
        
        // Apply search filter
        if (!string.IsNullOrEmpty(searchTerm))
        {
            customers = customers.Where(c => 
                c.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                c.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                c.CustomerId.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                c.Phone.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }
        
        // Apply category filter
        customers = selectedFilter switch
        {
            "Employed" => customers.Where(c => c.EmploymentStatus == "Employed"),
            "Unemployed" => customers.Where(c => c.EmploymentStatus == "Unemployed"),
            "With Loans" => customers.Where(c => c.HasActiveLoans),
            _ => customers
        };

        // Apply sorting
        customers = sortColumn switch
        {
            "Name" => sortAscending ? customers.OrderBy(c => c.Name) : customers.OrderByDescending(c => c.Name),
            "CustomerId" => sortAscending ? customers.OrderBy(c => c.CustomerId) : customers.OrderByDescending(c => c.CustomerId),
            "Email" => sortAscending ? customers.OrderBy(c => c.Email) : customers.OrderByDescending(c => c.Email),
            "Phone" => sortAscending ? customers.OrderBy(c => c.Phone) : customers.OrderByDescending(c => c.Phone),
            "EmploymentStatus" => sortAscending ? customers.OrderBy(c => c.EmploymentStatus) : customers.OrderByDescending(c => c.EmploymentStatus),
            "MonthlyIncome" => sortAscending ? customers.OrderBy(c => c.MonthlyIncome) : customers.OrderByDescending(c => c.MonthlyIncome),
            "HasActiveLoans" => sortAscending ? customers.OrderBy(c => c.HasActiveLoans) : customers.OrderByDescending(c => c.HasActiveLoans),
            _ => customers.OrderBy(c => c.Name)
        };
        
        return customers.ToList();
    }

    private List<CustomerModel> GetPagedCustomers()
    {
        var displayCustomers = GetDisplayCustomers();
        return displayCustomers.Skip(currentPage * pageSize).Take(pageSize).ToList();
    }

    private void ChangePage(int page)
    {
        currentPage = Math.Max(0, Math.Min(page, totalPages - 1));
        StateHasChanged();
    }

    // Statistics Methods
    private int GetEmployedCount()
    {
        return GetDisplayCustomers().Count(c => c.EmploymentStatus == "Employed");
    }

    private int GetLoanCustomersCount()
    {
        return GetDisplayCustomers().Count(c => c.HasActiveLoans);
    }

    private string GetAverageIncomeDisplay()
    {
        var customers = GetDisplayCustomers();
        if (!customers.Any()) return "$0";
        
        var avgIncome = customers.Average(c => c.MonthlyIncome);
        return $"${avgIncome:N0}";
    }

    // Sorting Methods
    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        StateHasChanged();
    }

    private string GetSortIcon(string column)
    {
        if (sortColumn != column) return "??";
        return sortAscending ? "??" : "??";
    }

    // Pagination Helper Methods
    private int GetStartPage()
    {
        return Math.Max(0, currentPage - 2);
    }

    private int GetEndPage()
    {
        return Math.Min(totalPages - 1, currentPage + 2);
    }

    // View Mode Methods
    private void SetViewMode(string mode)
    {
        viewMode = mode;
        StateHasChanged();
    }

    private async Task UpdatePageSize(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            pageSize = newSize;
            currentPage = 0;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    // Utility Methods
    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) 
            return "CU";
        
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        else if (parts.Length == 1 && parts[0].Length >= 2)
        {
            return parts[0].Substring(0, 2).ToUpper();
        }
        else if (parts.Length == 1 && parts[0].Length == 1)
        {
            return parts[0].ToUpper() + "U";
        }
        
        return "CU"; // Default fallback for Customer User
    }

    private string GetCustomerClass(string employmentStatus)
    {
        return employmentStatus.ToLower() switch
        {
            "employed" => "customer-employed",
            "unemployed" => "customer-unemployed",
            "self-employed" => "customer-self-employed",
            _ => ""
        };
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "employed" => "status-employed",
            "unemployed" => "status-unemployed",
            "self-employed" => "status-self-employed",
            "retired" => "status-retired",
            "student" => "status-student",
            _ => "status-default"
        };
    }

    private void ClearError()
    {
        dbErrorMessage = string.Empty;
        StateHasChanged();
    }

    // Enhanced Customer Management Actions  
    private void ExportCustomers()
    {
        Console.WriteLine("Exporting customer data...");
    }

    private void ViewCustomerDetails(CustomerModel customer)
    {
        Console.WriteLine($"Viewing comprehensive details for customer: {customer.Name}");
        
        // Show detailed customer information modal or navigate to detail page
        var details = new {
            Customer = customer,
            PersonalInfo = new {
                FullName = customer.Name,
                Email = customer.Email,
                Phone = customer.Phone,
                Address = customer.Address,
                DateOfBirth = customer.DateOfBirth?.ToString("MMM dd, yyyy") ?? "Not specified"
            },
            IdentificationInfo = new {
                IdType = customer.IdType,
                IdNumber = customer.IdNumber,
                IssuingAuthority = customer.IssuingAuthority,
                ExpirationDate = customer.ExpirationDate?.ToString("MMM dd, yyyy") ?? "Not specified"
            },
            EmploymentInfo = new {
                Status = customer.EmploymentStatus,
                Position = customer.Position,
                AnnualSalary = customer.AnnualSalary.ToString("C"),
                MonthlyIncome = customer.MonthlyIncome.ToString("C"),
                CertificateUrl = customer.CertificateUrl
            },
            AccountInfo = new {
                CustomerId = customer.CustomerId,
                HasActiveLoans = customer.HasActiveLoans,
                AssignedTeller = customer.AssignedTeller,
                CreatedAt = customer.CreatedAt.ToString("MMM dd, yyyy"),
                LastUpdated = customer.LastUpdated.ToString("MMM dd, yyyy"),
                Notes = customer.Notes
            }
        };
        
        // In a real implementation, this would show a detailed modal or navigate to a detail view
        Console.WriteLine($"Customer Details: {System.Text.Json.JsonSerializer.Serialize(details, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}");
    }

    private void EditCustomer(CustomerModel customer)
    {
        Console.WriteLine($"Editing customer: {customer.Name}");
        
        // Pre-populate the new customer modal with existing data for editing
        newCustomer = new NewCustomerModel
        {
            FirstName = customer.Name.Split(' ').FirstOrDefault() ?? "",
            LastName = customer.Name.Split(' ').LastOrDefault() ?? "",
            Email = customer.Email,
            Phone = customer.Phone,
            City = customer.Address?.Split(',').FirstOrDefault()?.Trim() ?? "",
            State = customer.Address?.Contains(',') == true ? customer.Address.Split(',')[1]?.Trim() ?? "" : "",
            ZipCode = customer.Address?.Split(' ').LastOrDefault() ?? "",
            IdType = customer.IdType,
            IdNumber = customer.IdNumber,
            IssuingAuthority = customer.IssuingAuthority,
            ExpirationDate = customer.ExpirationDate,
            IsEmployed = customer.EmploymentStatus == "Employed",
            AnnualSalary = customer.AnnualSalary,
            MonthlyIncome = customer.MonthlyIncome,
            Position = customer.Position,
            CertificateUrl = customer.CertificateUrl,
            AssignedTeller = customer.AssignedTeller
        };
        
        showAddCustomerModal = true;
        StateHasChanged();
    }

    private void ViewCustomerHistory(CustomerModel customer)
    {
        Console.WriteLine($"Viewing comprehensive history for customer: {customer.Name}");
        
        // Show detailed history including loans, payments, interactions
        var history = new {
            Customer = customer.Name,
            Timeline = new[] {
                new { Date = customer.CreatedAt, Action = "Customer Account Created", Details = $"Created by {customer.AssignedTeller}" },
                new { Date = customer.LastUpdated, Action = "Last Profile Update", Details = "Profile information updated" },
                new { Date = DateTime.Now.AddDays(-30), Action = "Loan Application", Details = "Applied for business loan - $50,000" },
                new { Date = DateTime.Now.AddDays(-15), Action = "Document Verification", Details = "ID documents verified and approved" },
                new { Date = DateTime.Now.AddDays(-10), Action = "Credit Check", Details = "Credit score verified: 720" },
                new { Date = DateTime.Now.AddDays(-5), Action = "Last Contact", Details = "Phone call regarding loan status" }
            },
            LoanHistory = new[] {
                new { LoanId = "L001", Amount = 50000, Status = "Active", StartDate = DateTime.Now.AddDays(-20) },
                new { LoanId = "L002", Amount = 25000, Status = "Completed", StartDate = DateTime.Now.AddDays(-200) }
            },
            PaymentHistory = new[] {
                new { PaymentId = "P001", Amount = 1500, Date = DateTime.Now.AddDays(-5), Status = "Completed" },
                new { PaymentId = "P002", Amount = 1500, Date = DateTime.Now.AddDays(-35), Status = "Completed" }
            },
            ContactHistory = new[] {
                new { Date = DateTime.Now.AddDays(-5), Type = "Phone", Notes = "Discussed payment schedule" },
                new { Date = DateTime.Now.AddDays(-15), Type = "Email", Notes = "Sent loan documents" },
                new { Date = DateTime.Now.AddDays(-30), Type = "In-Person", Notes = "Initial consultation" }
            }
        };
        
        Console.WriteLine($"Customer History: {System.Text.Json.JsonSerializer.Serialize(history, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}");
    }

    private void SendEmail(CustomerModel customer)
    {
        Console.WriteLine($"Composing email to customer: {customer.Email}");
        
        // Prepare email template with customer information
        var emailTemplate = new {
            To = customer.Email,
            Subject = "Important Update Regarding Your Account",
            Body = $@"
                Dear {customer.Name},

                We hope this message finds you well. This is a follow-up regarding your account with Fortress Finance.

                Account Details:
                - Customer ID: {customer.CustomerId}
                - Account Status: Active
                - Assigned Representative: {customer.AssignedTeller}

                If you have any questions or concerns, please don't hesitate to contact us.

                Best regards,
                Fortress Finance Team
                
                ---
                This is an automated message. Please do not reply directly to this email.
            ",
            CustomerInfo = new {
                Name = customer.Name,
                CustomerId = customer.CustomerId,
                Phone = customer.Phone,
                EmploymentStatus = customer.EmploymentStatus,
                MonthlyIncome = customer.MonthlyIncome.ToString("C")
            }
        };
        
        Console.WriteLine($"Email Template: {System.Text.Json.JsonSerializer.Serialize(emailTemplate, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}");
    }

    private async Task ArchiveCustomer(CustomerModel customer)
    {
        try
        {
            Console.WriteLine($"Archiving customer: {customer.Name}");
            
            // In a real implementation, you would:
            // 1. Move customer to archive table
            // 2. Keep audit trail
            // 3. Update related records
            // 4. Send notification
            
            var archiveReason = "Customer account archived by administrator";
            var archiveData = new {
                CustomerId = customer.CustomerId,
                CustomerName = customer.Name,
                Email = customer.Email,
                Phone = customer.Phone,
                EmploymentStatus = customer.EmploymentStatus,
                MonthlyIncome = customer.MonthlyIncome,
                ArchivedDate = DateTime.Now,
                ArchivedBy = "Admin User",
                ArchiveReason = archiveReason,
                OriginalData = customer
            };
            
            Console.WriteLine($"Archive Data: {System.Text.Json.JsonSerializer.Serialize(archiveData, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}");
            
            // Find the customer in the database and mark as archived instead of deleting
            var customerEntity = await Db.Customers
                .FirstOrDefaultAsync(c => c.CustomerId == customer.CustomerId);
            
            if (customerEntity != null)
            {
                // Instead of removing, mark as archived
                customerEntity.Notes = $"ARCHIVED on {DateTime.Now:yyyy-MM-dd} - {archiveReason}\n{customerEntity.Notes}";
                customerEntity.LastUpdated = DateTime.Now;
                
                // You could also add an IsArchived field to the database schema
                await Db.SaveChangesAsync();
                
                Console.WriteLine($"Customer {customer.CustomerId} archived in database");
                
                // Remove from active customer list
                allCustomers.RemoveAll(c => c.CustomerId == customer.CustomerId);
                StateHasChanged();
            }
            else
            {
                Console.WriteLine($"Customer {customer.CustomerId} not found in database");
                // Still remove from local list if not found in DB
                allCustomers.RemoveAll(c => c.CustomerId == customer.CustomerId);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error archiving customer: {ex.Message}");
            dbErrorMessage = $"Failed to archive customer: {ex.Message}";
            StateHasChanged();
        }
    }
}