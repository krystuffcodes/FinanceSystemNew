@page "/graphs"
@using System.ComponentModel.DataAnnotations

<PageTitle>Correlation Graphs & Analytics - Fortress Finance</PageTitle>

<div class="graphs-management-container">
    <!-- Header -->
    <div class="graphs-header">
        <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 3v18h18"/>
                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
            </svg>
            Correlation Graphs & Analytics
        </h1>
        <div class="user-info">
            <div class="user-avatar">A</div>
            <div class="user-details">
                <span class="user-name">Admin User</span>
                <span class="user-role">Administrator</span>
            </div>
        </div>
    </div>

    <!-- Subtitle -->
    <div class="graphs-subtitle">
        <p>Interactive visual analysis of financial metric correlations</p>
    </div>

    <!-- Enhanced Controls Section -->
    <div class="graphs-controls">
        <div class="control-group">
            <label for="chartType">?? Chart Type</label>
            <select id="chartType" @bind="selectedChartType" class="filter-select">
                <option value="All Charts">All Charts</option>
                <option value="Scatter Plot">Scatter Plot</option>
                <option value="Bar Chart">Bar Chart</option>
                <option value="Distribution">Distribution</option>
                <option value="Network">Network</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="correlationType">?? Correlation Type</label>
            <select id="correlationType" @bind="selectedCorrelationType" class="filter-select">
                <option value="All Correlations">All Correlations</option>
                <option value="Strong Positive">Strong Positive (0.7+)</option>
                <option value="Moderate Positive">Moderate Positive (0.4-0.7)</option>
                <option value="Weak/None">Weak/None (-0.4-0.4)</option>
                <option value="Moderate Negative">Moderate Negative (-0.7--0.4)</option>
                <option value="Strong Negative">Strong Negative (-1.0--0.7)</option>
            </select>
        </div>
        
        <div class="actions-section">
            <button class="btn btn-primary btn-medium" @onclick="RefreshGraphs">
                <span class="btn-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23,4 23,10 17,10"/>
                        <polyline points="1,20 1,14 7,14"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                </span>
                ?? Refresh
            </button>
        </div>
    </div>

    <!-- Correlation Statistics Cards -->
    <div class="correlation-stats">
        <div class="stat-card positive">
            <div class="stat-icon">
                ?
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetPositiveCorrelationsCount()</div>
                <div class="stat-label">POSITIVE CORRELATIONS</div>
                <div class="stat-description">Variables moving together</div>
            </div>
        </div>
        <div class="stat-card negative">
            <div class="stat-icon">
                ?
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetNegativeCorrelationsCount()</div>
                <div class="stat-label">NEGATIVE CORRELATIONS</div>
                <div class="stat-description">Variables moving inversely</div>
            </div>
        </div>
        <div class="stat-card strong">
            <div class="stat-icon">
                ?
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetStrongCorrelationsCount()</div>
                <div class="stat-label">STRONG CORRELATIONS</div>
                <div class="stat-description">|r| ? 0.7</div>
            </div>
        </div>
        <div class="stat-card average">
            <div class="stat-icon">
                ??
            </div>
            <div class="stat-content">
                <div class="stat-value">@GetAverageCorrelation()</div>
                <div class="stat-label">AVG CORRELATION</div>
                <div class="stat-description">Absolute average</div>
            </div>
        </div>
    </div>

    <!-- Correlation Strength Comparison Chart (Exact Match to Your Screenshot) -->
    <div class="chart-section">
        <div class="chart-header">
            <div class="chart-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                <h3>?? Correlation Strength Comparison</h3>
            </div>
            <p class="chart-description">Bar chart showing correlation coefficients for all metric pairs</p>
            <button class="download-btn" @onclick="DownloadChart" title="Download Chart">
                ??
            </button>
        </div>
        
        <div class="bar-chart-container">
            <div class="chart-legend">
                <span class="legend-item">
                    <div class="legend-color positive-correlation"></div>
                    ?? Correlation Coefficient
                </span>
            </div>
            
            <div class="enhanced-bar-chart">
                <!-- Y-axis labels positioned exactly like your screenshot -->
                <div class="y-axis-enhanced">
                    <div class="y-label">1.0</div>
                    <div class="y-label">0.8</div>
                    <div class="y-label">0.6</div>
                    <div class="y-label">0.4</div>
                    <div class="y-label">0.2</div>
                    <div class="y-label">0.0</div>
                    <div class="y-label">-0.2</div>
                </div>
                
                <!-- Enhanced bars matching your screenshot exactly -->
                <div class="chart-bars-enhanced">
                    @foreach (var correlation in GetChartCorrelations())
                    {
                        <div class="bar-item-enhanced">
                            <div class="bar-enhanced @GetBarClass(correlation.Value)" 
                                 style="height: @GetBarHeightEnhanced(correlation.Value)%"
                                 title="@correlation.VariablePair: @correlation.Value.ToString("F2")">
                            </div>
                            <div class="bar-label-enhanced">@GetChartLabel(correlation.VariablePair)</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Correlation Distribution Scatter Plot (Exact Match) -->
    <div class="chart-section">
        <div class="chart-header">
            <div class="chart-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="2"/>
                    <circle cx="12" cy="2" r="2"/>
                    <circle cx="12" cy="22" r="2"/>
                    <circle cx="2" cy="12" r="2"/>
                    <circle cx="22" cy="12" r="2"/>
                </svg>
                <h3>?? Correlation Distribution</h3>
            </div>
            <p class="chart-description">Scatter plot showing positive vs negative correlation distribution</p>
            <button class="download-btn" @onclick="DownloadChart" title="Download Chart">
                ??
            </button>
        </div>
        
        <div class="scatter-plot-container">
            <div class="chart-legend">
                <span class="legend-item">
                    <div class="legend-color scatter-point"></div>
                    ?? Correlations
                </span>
            </div>
            
            <div class="enhanced-scatter-plot">
                <!-- Y-axis matching your screenshot -->
                <div class="y-axis-scatter-enhanced">
                    <div class="y-axis-label-enhanced">Correlation Coefficient</div>
                    <div class="y-labels-enhanced">
                        <div class="y-label">1.0</div>
                        <div class="y-label">0.8</div>
                        <div class="y-label">0.6</div>
                        <div class="y-label">0.4</div>
                        <div class="y-label">0.2</div>
                        <div class="y-label">0</div>
                        <div class="y-label">-0.2</div>
                        <div class="y-label">-0.4</div>
                        <div class="y-label">-0.6</div>
                        <div class="y-label">-0.8</div>
                        <div class="y-label">-1.0</div>
                    </div>
                </div>
                
                <!-- Plot area with exact positioning from your screenshot -->
                <div class="plot-area-enhanced">
                    @{int index = 0;}
                    @foreach (var correlation in GetScatterPlotData())
                    {
                        <div class="scatter-point-enhanced @GetPointClass(correlation.Value)" 
                             style="left: @GetScatterXPosition(index)%; bottom: @GetScatterYPosition(correlation.Value)%"
                             title="@correlation.VariablePair: @correlation.Value.ToString("F2")">
                        </div>
                        index++;
                    }
                    
                    <!-- Grid lines for better visualization -->
                    <div class="grid-lines">
                        @for(int i = 0; i <= 10; i++)
                        {
                            <div class="horizontal-grid-line" style="bottom: @(i * 10)%"></div>
                        }
                        @for(int i = 0; i <= 9; i++)
                        {
                            <div class="vertical-grid-line" style="left: @(i * 11.11)%"></div>
                        }
                    </div>
                </div>
                
                <!-- X-axis matching your screenshot -->
                <div class="x-axis-scatter-enhanced">
                    <div class="x-labels-enhanced">
                        <div class="x-label">0</div>
                        <div class="x-label">1</div>
                        <div class="x-label">2</div>
                        <div class="x-label">3</div>
                        <div class="x-label">4</div>
                        <div class="x-label">5</div>
                        <div class="x-label">6</div>
                        <div class="x-label">7</div>
                        <div class="x-label">8</div>
                        <div class="x-label">9</div>
                    </div>
                    <div class="x-axis-label-enhanced">Metric Pair Index</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Correlation Network -->
    <div class="chart-section">
        <div class="chart-header">
            <div class="chart-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16.5 9.4l-9-5.19"/>
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                <h3>?? Correlation Network</h3>
            </div>
            <p class="chart-description">Network diagram showing relationships between financial metrics</p>
        </div>
        
        <div class="network-placeholder">
            <div class="network-message">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"/>
                    <circle cx="12" cy="2" r="1"/>
                    <circle cx="12" cy="22" r="1"/>
                    <circle cx="2" cy="12" r="1"/>
                    <circle cx="22" cy="12" r="1"/>
                    <circle cx="5.64" cy="5.64" r="1"/>
                    <circle cx="18.36" cy="18.36" r="1"/>
                    <circle cx="18.36" cy="5.64" r="1"/>
                    <circle cx="5.64" cy="18.36" r="1"/>
                </svg>
                <h4>?? Interactive Network Visualization</h4>
                <p>Advanced network chart showing metric relationships will be displayed here</p>
            </div>
        </div>
    </div>
</div>

@code {
    // Correlation Model
    public class CorrelationModel
    {
        public string VariablePair { get; set; } = "";
        public double Value { get; set; }
        public string Interpretation { get; set; } = "";
        public string Strength { get; set; } = "";
    }

    // State Management
    private List<CorrelationModel> allCorrelations = new();
    
    private bool isLoading = false;
    private string selectedChartType = "All Charts";
    private string selectedCorrelationType = "All Correlations";

    protected override async Task OnInitializedAsync()
    {
        await LoadCorrelationData();
    }

    private async Task LoadCorrelationData()
    {
        isLoading = true;
        
        // Sample correlation data matching your screenshots EXACTLY
        allCorrelations = new List<CorrelationModel>
        {
            new CorrelationModel 
            { 
                VariablePair = "Revenue ? Active Loans",
                Value = 0.92,
                Interpretation = "Strong Positive - Variables move together",
                Strength = "Very Strong"
            },
            new CorrelationModel 
            { 
                VariablePair = "Payment Rate ? Revenue",
                Value = 0.88,
                Interpretation = "Strong Positive - Variables move together",
                Strength = "Very Strong"
            },
            new CorrelationModel 
            { 
                VariablePair = "Overdue Accounts ? Default Rate",
                Value = 0.85,
                Interpretation = "Strong Positive - Variables move together",
                Strength = "Very Strong"
            },
            new CorrelationModel 
            { 
                VariablePair = "Customer ? Active Loans",
                Value = 0.78,
                Interpretation = "Strong Positive - Variables move together",
                Strength = "Strong"
            },
            new CorrelationModel 
            { 
                VariablePair = "Payment ? Customers",
                Value = 0.76,
                Interpretation = "Strong Positive - Variables move together",
                Strength = "Strong"
            },
            new CorrelationModel 
            { 
                VariablePair = "Loan ? Payment Rate",
                Value = 0.74,
                Interpretation = "Strong Positive - Variables move together",
                Strength = "Strong"
            },
            new CorrelationModel 
            { 
                VariablePair = "Daily Overdue ? Payment Rate",
                Value = -0.81,
                Interpretation = "Strong Negative - Variables move in opposite directions",
                Strength = "Strong"
            },
            new CorrelationModel 
            { 
                VariablePair = "Payment Percentage ? Customer Type",
                Value = 0.84,
                Interpretation = "Strong Positive - Variables move together",
                Strength = "Very Strong"
            },
            new CorrelationModel 
            { 
                VariablePair = "Active Loans ? Customer Type",
                Value = 0.78,
                Interpretation = "Strong Positive - Variables move together",
                Strength = "Strong"
            },
            new CorrelationModel 
            { 
                VariablePair = "Customer ? Customer Type",
                Value = 0.76,
                Interpretation = "Strong Positive - Variables move together",
                Strength = "Strong"
            }
        };
        
        isLoading = false;
    }

    // Statistics Methods
    private int GetPositiveCorrelationsCount()
    {
        return allCorrelations.Count(c => c.Value > 0);
    }

    private int GetNegativeCorrelationsCount()
    {
        return allCorrelations.Count(c => c.Value < 0);
    }

    private int GetStrongCorrelationsCount()
    {
        return allCorrelations.Count(c => Math.Abs(c.Value) >= 0.7);
    }

    private string GetAverageCorrelation()
    {
        if (!allCorrelations.Any()) return "0.00";
        
        var avg = allCorrelations.Average(c => Math.Abs(c.Value));
        return avg.ToString("F2");
    }

    // Chart Data Methods (Enhanced for exact match)
    private List<CorrelationModel> GetAllCorrelations()
    {
        return allCorrelations;
    }

    private List<CorrelationModel> GetChartCorrelations()
    {
        // Return specific correlations for bar chart to match your screenshot
        return allCorrelations.Take(10).ToList();
    }

    private List<CorrelationModel> GetScatterPlotData()
    {
        // Return all correlations for scatter plot
        return allCorrelations;
    }

    // Chart Styling Methods (Enhanced)
    private string GetBarClass(double value)
    {
        if (value >= 0)
            return "bar-positive-enhanced";
        else
            return "bar-negative-enhanced";
    }

    private string GetPointClass(double value)
    {
        return Math.Abs(value) switch
        {
            >= 0.7 => "point-strong-enhanced",
            >= 0.4 => "point-moderate-enhanced",
            _ => "point-weak-enhanced"
        };
    }

    private double GetBarHeightEnhanced(double value)
    {
        // Enhanced calculation for better visual match
        var absValue = Math.Abs(value);
        return absValue * 90; // Scale to 90% max height for better appearance
    }

    private double GetScatterXPosition(int index)
    {
        // Better distribution across the plot area
        return (index * 100.0) / Math.Max(1, allCorrelations.Count - 1);
    }

    private double GetScatterYPosition(double value)
    {
        // Enhanced positioning for scatter plot
        return ((value + 1) / 2) * 100;
    }

    private string GetChartLabel(string variablePair)
    {
        // Enhanced labels for better readability
        var parts = variablePair.Split('?');
        if (parts.Length == 2)
        {
            var first = parts[0].Trim();
            var second = parts[1].Trim();
            
            // Shorten common words
            first = first.Replace("Revenue", "Rev").Replace("Active Loans", "Loans").Replace("Payment", "Pay");
            second = second.Replace("Revenue", "Rev").Replace("Active Loans", "Loans").Replace("Payment", "Pay");
            
            return $"{first} ? {second}";
        }
        return variablePair.Length > 20 ? variablePair.Substring(0, 17) + "..." : variablePair;
    }

    // Action Methods
    private void RefreshGraphs()
    {
        Console.WriteLine("?? Refreshing correlation graphs...");
        StateHasChanged();
    }

    private void DownloadChart()
    {
        Console.WriteLine("?? Downloading chart...");
    }
}