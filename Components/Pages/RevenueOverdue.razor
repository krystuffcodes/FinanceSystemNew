@page "/revenue-overdue"
@using System.ComponentModel.DataAnnotations
@using Microsoft.EntityFrameworkCore
@inject FinanceSystem1.Data.AppDbContext Db

<PageTitle>Customer Revenue Summary - Fortress Finance</PageTitle>

<div class="revenue-management-container">
    <!-- Header -->
    <div class="revenue-header">
        <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                <line x1="12" y1="18" x2="12" y2="22"/>
            </svg>
            Customer Revenue Summary
        </h1>
        <div class="user-info">
            <div class="user-avatar">A</div>
            <div class="user-details">
                <span class="user-name">Admin User</span>
                <span class="user-role">Administrator</span>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-btn @(activeTab == "revenue" ? "active" : "")" @onclick="@(() => SetActiveTab("revenue"))">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                <line x1="12" y1="18" x2="12" y2="22"/>
            </svg>
            Customer Revenue Summary
        </button>
        <button class="tab-btn @(activeTab == "overdue" ? "active" : "")" @onclick="@(() => SetActiveTab("overdue"))">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            Overdue Accounts
        </button>
    </div>

    @if (activeTab == "revenue")
    {
        <!-- Revenue Tab Content -->
        <div class="revenue-content">
            <!-- Search and Filters -->
            <div class="revenue-controls">
                <div class="search-section">
                    <div class="search-container">
                        <span class="search-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="21 21l-4.35-4.35"/>
                            </svg>
                        </span>
                        <input type="text" placeholder="Search by customer name..." @bind="revenueSearchTerm" @oninput="HandleRevenueSearch" class="search-input" />
                    </div>
                </div>
                
                <div class="filter-section">
                    <select @bind="revenueSelectedFilter" class="filter-select">
                        <option value="All">All</option>
                        <option value="Active Loans">Active Loans</option>
                        <option value="Completed Loans">Completed Loans</option>
                        <option value="High Revenue">High Revenue</option>
                    </select>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="revenue-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            <line x1="12" y1="18" x2="12" y2="22"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@GetTotalRevenueDisplay()</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@GetDisplayRevenueData().Count()</div>
                        <div class="stat-label">Active Customers</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@GetAverageRevenueDisplay()</div>
                        <div class="stat-label">Avg Revenue</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@GetInterestEarnedDisplay()</div>
                        <div class="stat-label">Interest Earned</div>
                    </div>
                </div>
            </div>

            @if (isRevenueLoading)
            {
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <span>Loading revenue data...</span>
                </div>
            }
            else if (!GetDisplayRevenueData().Any())
            {
                <div class="empty-container">
                    <div class="empty-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            <line x1="12" y1="18" x2="12" y2="22"/>
                        </svg>
                    </div>
                    <h4>No revenue data found</h4>
                    <p>Revenue data will appear here once customers have loans and payments.</p>
                </div>
            }
            else
            {
                <!-- Revenue Table -->
                <div class="table-section">
                    <div class="table-header">
                        <h3>Revenue Summary (@GetDisplayRevenueData().Count())</h3>
                    </div>

                    <div class="table-container">
                        <table class="revenue-table">
                            <thead>
                                <tr>
                                    <th @onclick="@(() => SortRevenueBy("CustomerName"))">
                                        Customer @GetRevenueSortIcon("CustomerName")
                                    </th>
                                    <th @onclick="@(() => SortRevenueBy("LoanAmount"))">
                                        Loan Amount @GetRevenueSortIcon("LoanAmount")
                                    </th>
                                    <th @onclick="@(() => SortRevenueBy("InterestRate"))">
                                        Interest Rate @GetRevenueSortIcon("InterestRate")
                                    </th>
                                    <th @onclick="@(() => SortRevenueBy("PaidAmount"))">
                                        Paid Amount @GetRevenueSortIcon("PaidAmount")
                                    </th>
                                    <th @onclick="@(() => SortRevenueBy("InterestEarned"))">
                                        Interest Earned @GetRevenueSortIcon("InterestEarned")
                                    </th>
                                    <th @onclick="@(() => SortRevenueBy("Status"))">
                                        Status @GetRevenueSortIcon("Status")
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var revenue in GetDisplayRevenueData())
                                {
                                    <tr class="revenue-row @GetRevenueRowClass(revenue.Status)">
                                        <td class="customer-name">
                                            <div class="name-cell">
                                                <div class="customer-avatar-small">@GetInitials(revenue.CustomerName)</div>
                                                <div class="name-info">
                                                    <strong>@revenue.CustomerName</strong>
                                                    <small>ID: @revenue.CustomerId</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="loan-amount">
                                            <strong>@((revenue.LoanAmount ?? 0).ToString("C0"))</strong>
                                        </td>
                                        <td class="interest-rate">
                                            @((revenue.InterestRate ?? 0).ToString("F2"))%
                                        </td>
                                        <td class="paid-amount">
                                            <strong>@((revenue.PaidAmount ?? 0).ToString("C0"))</strong>
                                            <small>@GetPaymentProgress(revenue)%</small>
                                        </td>
                                        <td class="interest-earned">
                                            <strong class="interest-value">@((revenue.InterestEarned ?? 0).ToString("C2"))</strong>
                                        </td>
                                        <td class="revenue-status">
                                            <span class="status-badge @GetRevenueStatusClass(revenue.Status)">
                                                @revenue.Status
                                            </span>
                                        </td>
                                        <td class="revenue-actions">
                                            <div class="action-buttons">
                                                <button class="btn-icon" title="View Details" @onclick="() => ViewRevenueDetails(revenue)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                        <circle cx="12" cy="12" r="3"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    }
    else if (activeTab == "overdue")
    {
        <!-- Overdue Tab Content -->
        <div class="overdue-content">
            <!-- Overdue Stats -->
            <div class="revenue-stats">
                <div class="stat-card overdue">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@GetTotalOverdueDisplay()</div>
                        <div class="stat-label">Total Overdue</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@GetOverdueAccountsCount()</div>
                        <div class="stat-label">Overdue Accounts</div>
                    </div>
                </div>
            </div>

            @if (!GetOverdueAccounts().Any())
            {
                <div class="empty-container">
                    <div class="empty-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20,6 9,17 4,12"/>
                        </svg>
                    </div>
                    <h4>No overdue accounts found</h4>
                    <p>All accounts are up to date with payments.</p>
                </div>
            }
            else
            {
                <!-- Overdue Table -->
                <div class="table-section">
                    <div class="table-header">
                        <h3>Overdue Accounts (@GetOverdueAccounts().Count())</h3>
                    </div>

                    <div class="table-container">
                        <table class="revenue-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Outstanding Amount</th>
                                    <th>Days Overdue</th>
                                    <th>Last Payment</th>
                                    <th>Next Due Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var overdue in GetOverdueAccounts())
                                {
                                    <tr class="revenue-row overdue-row">
                                        <td class="customer-name">
                                            <div class="name-cell">
                                                <div class="customer-avatar-small">@GetInitials(overdue.CustomerName)</div>
                                                <div class="name-info">
                                                    <strong>@overdue.CustomerName</strong>
                                                    <small>ID: @overdue.CustomerId</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="outstanding-amount">
                                            <strong class="overdue-amount">@((overdue.OutstandingAmount ?? 0).ToString("C0"))</strong>
                                        </td>
                                        <td class="days-overdue">
                                            <span class="overdue-badge @GetOverdueSeverityClass(overdue.DaysOverdue ?? 0)">
                                                @(overdue.DaysOverdue ?? 0) days
                                            </span>
                                        </td>
                                        <td class="last-payment">
                                            @((overdue.LastPaymentDate ?? DateTime.Now).ToString("MMM dd, yyyy"))
                                        </td>
                                        <td class="next-due">
                                            @((overdue.NextDueDate ?? DateTime.Now).ToString("MMM dd, yyyy"))
                                        </td>
                                        <td class="revenue-actions">
                                            <div class="action-buttons">
                                                <button class="btn-icon" title="Send Reminder" @onclick="() => SendReminder(overdue)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                                        <polyline points="22,6 12,13 2,6"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    // Revenue Data Model
    public class RevenueDataModel
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string CustomerId { get; set; } = "";
        public string CustomerName { get; set; } = "";
        public decimal? LoanAmount { get; set; }
        public decimal? InterestRate { get; set; }
        public decimal? PaidAmount { get; set; }
        public decimal? InterestEarned { get; set; }
        public string Status { get; set; } = "";
        public DateTime? LoanDate { get; set; } = DateTime.Now;
        public DateTime? LastPaymentDate { get; set; } = DateTime.Now;
    }

    // Overdue Account Model
    public class OverdueAccountModel
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string CustomerId { get; set; } = "";
        public string CustomerName { get; set; } = "";
        public decimal? OutstandingAmount { get; set; }
        public int? DaysOverdue { get; set; }
        public DateTime? LastPaymentDate { get; set; } = DateTime.Now;
        public DateTime? NextDueDate { get; set; } = DateTime.Now;
    }

    // State Management
    private List<RevenueDataModel> allRevenueData = new();
    private List<OverdueAccountModel> allOverdueAccounts = new();
    
    private string activeTab = "revenue";
    private bool isRevenueLoading = false;

    // Revenue Tab State
    private string revenueSearchTerm = "";
    private string revenueSelectedFilter = "All";
    private string revenueSortColumn = "CustomerName";
    private bool revenueSortAscending = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadSampleData();
    }

    private async Task LoadSampleData()
    {
        isRevenueLoading = true;
        try
        {
            var revenues = await Db.RevenueDatas.AsNoTracking().ToListAsync();
            allRevenueData = revenues.Select(r => new RevenueDataModel
            {
                Id = r.Id.ToString(),
                CustomerId = r.CustomerId,
                CustomerName = r.CustomerName,
                LoanAmount = r.LoanAmount,
                InterestRate = r.InterestRate,
                PaidAmount = r.PaidAmount,
                InterestEarned = r.InterestEarned,
                Status = r.Status,
                LoanDate = r.LoanDate,
                LastPaymentDate = r.LastPaymentDate
            }).ToList();

            var overdues = await Db.OverdueAccounts.AsNoTracking().ToListAsync();
            allOverdueAccounts = overdues.Select(o => new OverdueAccountModel
            {
                Id = o.Id.ToString(),
                CustomerId = o.CustomerId,
                CustomerName = o.CustomerName,
                OutstandingAmount = o.OutstandingAmount,
                DaysOverdue = o.DaysOverdue,
                LastPaymentDate = o.LastPaymentDate,
                NextDueDate = o.NextDueDate
            }).ToList();
        }
        catch
        {
            allRevenueData = new List<RevenueDataModel>();
            allOverdueAccounts = new List<OverdueAccountModel>();
        }
        finally
        {
            isRevenueLoading = false;
        }
    }

    // Tab Management
    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    // Revenue Tab Methods
    private async Task HandleRevenueSearch(ChangeEventArgs e)
    {
        revenueSearchTerm = e.Value?.ToString() ?? "";
        await Task.CompletedTask;
    }

    private IEnumerable<RevenueDataModel> GetDisplayRevenueData()
    {
        var data = allRevenueData.AsQueryable();
        
        // Apply search filter
        if (!string.IsNullOrEmpty(revenueSearchTerm))
        {
            data = data.Where(r => 
                r.CustomerName.Contains(revenueSearchTerm, StringComparison.OrdinalIgnoreCase) ||
                r.CustomerId.Contains(revenueSearchTerm, StringComparison.OrdinalIgnoreCase));
        }
        
        // Apply category filter
        data = revenueSelectedFilter switch
        {
            "Active Loans" => data.Where(r => r.Status == "Active"),
            "Completed Loans" => data.Where(r => r.Status == "Completed"),
            "High Revenue" => data.Where(r => (r.InterestEarned ?? 0) > 3000),
            _ => data
        };

        // Apply sorting
        data = revenueSortColumn switch
        {
            "CustomerName" => revenueSortAscending ? data.OrderBy(r => r.CustomerName) : data.OrderByDescending(r => r.CustomerName),
            "LoanAmount" => revenueSortAscending ? data.OrderBy(r => r.LoanAmount ?? 0) : data.OrderByDescending(r => r.LoanAmount ?? 0),
            "InterestRate" => revenueSortAscending ? data.OrderBy(r => r.InterestRate ?? 0) : data.OrderByDescending(r => r.InterestRate ?? 0),
            "PaidAmount" => revenueSortAscending ? data.OrderBy(r => r.PaidAmount ?? 0) : data.OrderByDescending(r => r.PaidAmount ?? 0),
            "InterestEarned" => revenueSortAscending ? data.OrderBy(r => r.InterestEarned ?? 0) : data.OrderByDescending(r => r.InterestEarned ?? 0),
            "Status" => revenueSortAscending ? data.OrderBy(r => r.Status) : data.OrderByDescending(r => r.Status),
            _ => data.OrderBy(r => r.CustomerName)
        };
        
        return data.ToList();
    }

    private void SortRevenueBy(string column)
    {
        if (revenueSortColumn == column)
        {
            revenueSortAscending = !revenueSortAscending;
        }
        else
        {
            revenueSortColumn = column;
            revenueSortAscending = true;
        }
        StateHasChanged();
    }

    private string GetRevenueSortIcon(string column)
    {
        if (revenueSortColumn != column) return "";
        return revenueSortAscending ? "?" : "?";
    }

    // Overdue Tab Methods
    private IEnumerable<OverdueAccountModel> GetOverdueAccounts()
    {
        return allOverdueAccounts.OrderByDescending(o => o.DaysOverdue ?? 0);
    }

    // Statistics Methods
    private string GetTotalRevenueDisplay()
    {
        var total = GetDisplayRevenueData().Sum(r => r.InterestEarned ?? 0);
        return total.ToString("C0");
    }

    private string GetAverageRevenueDisplay()
    {
        var data = GetDisplayRevenueData();
        if (!data.Any()) return "$0";
        
        var validRevenues = data.Where(r => r.InterestEarned.HasValue).ToList();
        if (!validRevenues.Any()) return "$0";
        
        var avg = validRevenues.Average(r => r.InterestEarned.Value);
        return avg.ToString("C0");
    }

    private string GetInterestEarnedDisplay()
    {
        var total = GetDisplayRevenueData().Sum(r => r.InterestEarned ?? 0);
        return total.ToString("C2");
    }

    private string GetTotalOverdueDisplay()
    {
        var total = GetOverdueAccounts().Sum(o => o.OutstandingAmount ?? 0);
        return total.ToString("C0");
    }

    private int GetOverdueAccountsCount()
    {
        return GetOverdueAccounts().Count();
    }

    // Utility Methods
    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) 
            return "CU";
        
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        else if (parts.Length == 1 && parts[0].Length >= 2)
        {
            return parts[0].Substring(0, 2).ToUpper();
        }
        
        return "CU";
    }

    private string GetRevenueRowClass(string status)
    {
        return status.ToLower() switch
        {
            "active" => "revenue-active",
            "completed" => "revenue-completed",
            "overdue" => "revenue-overdue",
            _ => ""
        };
    }

    private string GetRevenueStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "active" => "status-active",
            "completed" => "status-completed",
            "overdue" => "status-overdue",
            _ => "status-default"
        };
    }

    private string GetOverdueSeverityClass(int daysOverdue)
    {
        return daysOverdue switch
        {
            >= 90 => "overdue-severe",
            >= 60 => "overdue-high",
            >= 30 => "overdue-moderate",
            _ => "overdue-low"
        };
    }

    private string GetPaymentProgress(RevenueDataModel revenue)
    {
        if ((revenue.LoanAmount ?? 0) == 0) return "0";
        var progress = ((revenue.PaidAmount ?? 0) / (revenue.LoanAmount ?? 1)) * 100;
        return progress.ToString("F0");
    }

    // Action Methods
    private void ViewRevenueDetails(RevenueDataModel revenue)
    {
        Console.WriteLine($"Viewing comprehensive revenue details for: {revenue.CustomerName}");
        
        // Show detailed revenue analysis
        var details = new {
            Revenue = revenue,
            CustomerInfo = new {
                CustomerId = revenue.CustomerId,
                CustomerName = revenue.CustomerName,
                AccountAge = CalculateAccountAge(revenue.LoanDate ?? DateTime.Now)
            },
            LoanDetails = new {
                LoanAmount = revenue.LoanAmount?.ToString("C") ?? "N/A",
                InterestRate = $"{revenue.InterestRate ?? 0:F2}%",


                LoanDate = revenue.LoanDate?.ToString("MMM dd, yyyy") ?? "N/A",
                Status = revenue.Status
            },
            PaymentAnalysis = new {
                PaidAmount = revenue.PaidAmount?.ToString("C") ?? "N/A",
                RemainingBalance = (revenue.LoanAmount - revenue.PaidAmount)?.ToString("C") ?? "N/A",
                PaymentProgress = GetPaymentProgress(revenue) + "%",
                LastPaymentDate = revenue.LastPaymentDate?.ToString("MMM dd, yyyy") ?? "N/A"
            },
            RevenueMetrics = new {
                InterestEarned = revenue.InterestEarned?.ToString("C") ?? "N/A",
                PrincipalPaid = revenue.PaidAmount?.ToString("C") ?? "N/A",
                TotalExpectedRevenue = CalculateTotalExpectedRevenue(revenue).ToString("C"),
                RevenueRealizationRate = CalculateRevenueRealizationRate(revenue) + "%"
            },
            RiskAssessment = new {
                PaymentConsistency = AssessPaymentConsistency(revenue),
                DefaultRisk = AssessDefaultRisk(revenue),
                CollectionProbability = CalculateCollectionProbability(revenue) + "%"
            },
            ProfitabilityAnalysis = new {
                NetPresentValue = CalculateNPV(revenue).ToString("C"),
                ReturnOnInvestment = CalculateROI(revenue) + "%",
                EffectiveInterestRate = CalculateEffectiveInterestRate(revenue) + "%"
            }
        };
        
        Console.WriteLine($"Revenue Details: {System.Text.Json.JsonSerializer.Serialize(details, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}");
    }

    private void SendReminder(OverdueAccountModel overdue)
    {
        Console.WriteLine($"Sending comprehensive reminder to: {overdue.CustomerName}");
        
        // Prepare detailed reminder with multiple contact methods
        var reminderDetails = new {
            Customer = overdue,
            ReminderType = DetermineReminderType(overdue.DaysOverdue ?? 0),
            ContactMethods = new[] {
                new { Method = "Email", Priority = 1, Template = "Overdue_Email_Template" },
                new { Method = "SMS", Priority = 2, Template = "Overdue_SMS_Template" },
                new { Method = "Phone Call", Priority = 3, Template = "Overdue_Call_Script" }
            },
            ReminderContent = new {
                Subject = GenerateReminderSubject(overdue),
                Body = GenerateReminderBody(overdue),
                UrgencyLevel = DetermineUrgencyLevel(overdue.DaysOverdue ?? 0)
            },
            PaymentOptions = new {
                OnlinePayment = "Available through customer portal",
                PhonePayment = "Call 1-800-FORTRESS",
                BankTransfer = "Account details provided in reminder",
                PaymentPlan = "Installment options available"
            },
            LegalConsiderations = new {
                GracePeriod = CalculateRemainingGracePeriod(overdue.DaysOverdue ?? 0),
                CollectionAgencyReferral = (overdue.DaysOverdue ?? 0) > 90 ? "Pending" : "Not applicable",
                LegalActionThreshold = "120 days overdue"
            }
        };
        
        Console.WriteLine($"Reminder Details: {System.Text.Json.JsonSerializer.Serialize(reminderDetails, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}");
    }

    // Helper methods for revenue analysis
    private string CalculateAccountAge(DateTime loanDate)
    {
        var age = DateTime.Now - loanDate;
        return $"{age.Days} days ({age.Days / 30} months)";
    }
    
    private decimal CalculateTotalExpectedRevenue(RevenueDataModel revenue)
    {
        return (revenue.LoanAmount ?? 0) * (revenue.InterestRate ?? 0) / 100;
    }
    
    private string CalculateRevenueRealizationRate(RevenueDataModel revenue)
    {
        var expected = CalculateTotalExpectedRevenue(revenue);
        if (expected == 0) return "0";
        
        var realized = revenue.InterestEarned ?? 0;
        return ((realized / expected) * 100).ToString("F1");
    }
    
    private string AssessPaymentConsistency(RevenueDataModel revenue)
    {
        // Mock assessment based on payment progress
        var progress = int.Parse(GetPaymentProgress(revenue));
        return progress switch
        {
            > 80 => "Excellent",
            > 60 => "Good", 
            > 40 => "Fair",
            _ => "Poor"
        };
    }
    
    private string AssessDefaultRisk(RevenueDataModel revenue)
    {
        var progress = int.Parse(GetPaymentProgress(revenue));
        return progress switch
        {
            > 80 => "Low",
            > 50 => "Medium",
            _ => "High"
        };
    }
    
    private string CalculateCollectionProbability(RevenueDataModel revenue)
    {
        var progress = int.Parse(GetPaymentProgress(revenue));
        return Math.Min(progress + 20, 100).ToString();
    }
    
    private decimal CalculateNPV(RevenueDataModel revenue)
    {
        // Simplified NPV calculation
        var cashFlow = revenue.InterestEarned ?? 0;
        var discountRate = 0.1m; // 10% discount rate
        return cashFlow / (1 + discountRate);
    }
    
    private string CalculateROI(RevenueDataModel revenue)
    {
        if ((revenue.LoanAmount ?? 0) == 0) return "0";
        
        var profit = revenue.InterestEarned ?? 0;
        var investment = revenue.LoanAmount ?? 1;
        return ((profit / investment) * 100).ToString("F1");
    }
    
    private string CalculateEffectiveInterestRate(RevenueDataModel revenue)
    {
        // Account for any fees or adjustments
        return (revenue.InterestRate ?? 0).ToString("F2");
    }
    
    // Helper methods for overdue account management
    private string DetermineReminderType(int daysOverdue)
    {
        return daysOverdue switch
        {
            <= 30 => "Friendly Reminder",
            <= 60 => "Payment Notice",
            <= 90 => "Urgent Notice",
            _ => "Final Notice"
        };
    }
    
    private string GenerateReminderSubject(OverdueAccountModel overdue)
    {
        var urgency = DetermineReminderType(overdue.DaysOverdue ?? 0);
        return $"{urgency}: Payment Due - Account {overdue.CustomerId}";
    }
    
    private string GenerateReminderBody(OverdueAccountModel overdue)
    {
        return $@"
            Dear {overdue.CustomerName},

            This is a {DetermineReminderType(overdue.DaysOverdue ?? 0).ToLower()} regarding your overdue payment.

            Account Details:
            - Customer ID: {overdue.CustomerId}
            - Outstanding Amount: {overdue.OutstandingAmount:C}
            - Days Overdue: {overdue.DaysOverdue}
            - Next Due Date: {overdue.NextDueDate:MMM dd, yyyy}

            Please contact us immediately to resolve this matter.

            Fortress Finance Customer Service
        ";
    }
    
    private string DetermineUrgencyLevel(int daysOverdue)
    {
        return daysOverdue switch
        {
            <= 30 => "Low",
            <= 60 => "Medium",
            <= 90 => "High",
            _ => "Critical"
        };
    }
    
    private string CalculateRemainingGracePeriod(int daysOverdue)
    {
        var gracePeriod = 120; // 120 days before legal action
        var remaining = gracePeriod - daysOverdue;
        return remaining > 0 ? $"{remaining} days" : "Expired";
    }
}