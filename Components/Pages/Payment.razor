@page "/payment"
@using System.ComponentModel.DataAnnotations
@using Microsoft.EntityFrameworkCore
@inject FinanceSystem1.Data.AppDbContext Db

<PageTitle>Payment Tracking - Fortress Finance</PageTitle>

<div class="payment-tracking-container">
    <div class="payment-header">
        <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                <line x1="1" y1="10" x2="23" y2="10"/>
                <path d="M12 14h4"/>
                <path d="M14 12v4"/>
            </svg>
            Payment Tracking
        </h1>
        <div class="user-info">
            <div class="user-avatar">A</div>
            <div class="user-details">
                <span class="user-name">Admin User</span>
                <span class="user-role">Administrator</span>
            </div>
        </div>
    </div>

    <div class="tab-navigation">
        <button class="tab-button @(activeTab == "add" ? "active" : "")" @onclick='() => SetActiveTab("add")'>
            <span class="tab-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                    <line x1="1" y1="10" x2="23" y2="10"/>
                    <path d="M12 14h4"/>
                    <path d="M14 12v4"/>
                </svg>
            </span>
            Add Payment
        </button>
        <button class="tab-button @(activeTab == "view" ? "active" : "")" @onclick='() => SetActiveTab("view")'>
            <span class="tab-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="9" y1="15" x2="15" y2="15"/>
                    <line x1="9" y1="12" x2="12" y2="12"/>
                    <line x1="9" y1="18" x2="15" y2="18"/>
                </svg>
            </span>
            View
        </button>
    </div>

    <div class="tab-content">
        @if (activeTab == "add")
        {
            <div class="add-payment-section">
                <EditForm Model="newPayment" OnValidSubmit="ProcessPayment">
                    <DataAnnotationsValidator />
                    
                    <div class="form-section">
                        <h3 class="section-title">Customer Information</h3>
                        <div class="form-group">
                            <label for="customerName">Customer Name *</label>
                            <InputText id="customerName" @bind-Value="newPayment.CustomerName" 
                                      placeholder="Search customer..." class="form-control" />
                            <ValidationMessage For="@(() => newPayment.CustomerName)" />
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Basic Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="paymentDate">Payment Date *</label>
                                <InputDate id="paymentDate" @bind-Value="newPayment.PaymentDate" class="form-control" />
                                <ValidationMessage For="@(() => newPayment.PaymentDate)" />
                            </div>
                            <div class="form-group">
                                <label for="amount">Amount *</label>
                                <InputNumber id="amount" @bind-Value="newPayment.Amount" class="form-control" />
                                <ValidationMessage For="@(() => newPayment.Amount)" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="paymentMethod">Payment Method *</label>
                                <InputSelect id="paymentMethod" @bind-Value="newPayment.PaymentMethod" class="form-control">
                                    <option value="">Select payment method</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Credit Card">Credit Card</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => newPayment.PaymentMethod)" />
                            </div>
                            <div class="form-group">
                                <label for="paymentStatus">Payment Status *</label>
                                <InputSelect id="paymentStatus" @bind-Value="newPayment.Status" class="form-control">
                                    <option value="">Select status</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Failed">Failed</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => newPayment.Status)" />
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Payment Reference</h3>
                        <div class="form-group">
                            <label for="referenceId">Reference ID *</label>
                            <InputText id="referenceId" @bind-Value="newPayment.ReferenceId" 
                                      placeholder="Auto-generated" class="form-control" />
                            <ValidationMessage For="@(() => newPayment.ReferenceId)" />
                        </div>
                        <div class="form-group">
                            <label for="description">Description</label>
                            <InputTextArea id="description" @bind-Value="newPayment.Description" 
                                          placeholder="Brief description" class="form-control" rows="3" />
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" @onclick="ClearForm">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3,6 5,6 21,6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Clear All
                        </button>
                        <button type="submit" class="btn btn-primary" disabled="@isProcessing">
                            @if (isProcessing)
                            {
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                </svg>
                                <span>Processing...</span>
                            }
                            else
                            {
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                                <span>Process Payment</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        }
        else if (activeTab == "view")
        {
            <div class="view-payments-section">
                <div class="view-header">
                    <h3>Payment Records (@allPayments.Count)</h3>
                </div>

                @if (isLoading)
                {
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <span>Loading payment records...</span>
                    </div>
                }
                else if (!allPayments.Any())
                {
                    <div class="empty-container">
                        <div class="empty-icon">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                                <circle cx="12" cy="14" r="2"/>
                            </svg>
                        </div>
                        <h4>No Payment Records Found</h4>
                        <p>No payments found. Add new payments to see them here.</p>
                    </div>
                }
                else
                {
                    <div class="table-container">
                        <table class="payments-table">
                            <thead>
                                <tr>
                                    <th>Reference ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var payment in allPayments.OrderByDescending(p => p.PaymentDate))
                                {
                                    <tr class="payment-row @GetRowClass(payment.Status)">
                                        <td>
                                            <strong>@payment.ReferenceId</strong>
                                        </td>
                                        <td>@payment.CustomerName</td>
                                        <td>@payment.PaymentDate.ToString("MMM dd, yyyy")</td>
                                        <td><strong>$@payment.Amount.ToString("N2")</strong></td>
                                        <td>
                                            <div class="payment-method-cell">
                                                @if (payment.PaymentMethod == "Cash")
                                                {
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <line x1="12" y1="1" x2="12" y2="3"/>
                                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                                        <line x1="12" y1="21" x2="12" y2="23"/>
                                                    </svg>
                                                }
                                                else if (payment.PaymentMethod == "Bank Transfer")
                                                {
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                                        <polyline points="9,22 9,12 15,12 15,22"/>
                                                    </svg>
                                                }
                                                else if (payment.PaymentMethod == "Credit Card")
                                                {
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                                        <line x1="1" y1="10" x2="23" y2="10"/>
                                                    </svg>
                                                }
                                                <span>@payment.PaymentMethod</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge @GetStatusClass(payment.Status)">
                                                @if (payment.Status == "Completed")
                                                {
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M20 6L9 17l-5-5"/>
                                                    </svg>
                                                }
                                                else if (payment.Status == "Pending")
                                                {
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"/>
                                                        <polyline points="12,6 12,12 16,14"/>
                                                    </svg>
                                                }
                                                else if (payment.Status == "Failed")
                                                {
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"/>
                                                        <line x1="15" y1="9" x2="9" y2="15"/>
                                                        <line x1="9" y1="9" x2="15" y2="15"/>
                                                    </svg>
                                                }
                                                <span>@payment.Status</span>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="btn-icon" title="View Details" @onclick="() => ViewPaymentDetails(payment)">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                        <circle cx="12" cy="12" r="3"/>
                                                    </svg>
                                                </button>
                                                <button class="btn-icon" title="Edit Payment" @onclick="() => EditPayment(payment)">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                        <path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                                    </svg>
                                                </button>
                                                <button class="btn-icon archive" title="Archive Payment" @onclick="() => ArchivePayment(payment)">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="21,8 21,21 3,21 3,8"/>
                                                        <rect x="1" y="3" width="22" height="5"/>
                                                        <line x1="10" y1="12" x2="14" y2="12"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    public class PaymentModel
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        
        [Required(ErrorMessage = "Customer name is required")]
        public string CustomerName { get; set; } = "";
        
        [Required(ErrorMessage = "Payment date is required")]
        public DateTime PaymentDate { get; set; } = DateTime.Today;
        
        [Required(ErrorMessage = "Amount is required")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Amount must be greater than 0")]
        public decimal Amount { get; set; }
        
        [Required(ErrorMessage = "Payment method is required")]
        public string PaymentMethod { get; set; } = "";
        
        [Required(ErrorMessage = "Payment status is required")]
        public string Status { get; set; } = "";
        
        [Required(ErrorMessage = "Reference ID is required")]
        public string ReferenceId { get; set; } = "";
        
        public string Description { get; set; } = "";
        public DateTime CreatedAt { get; set; } = DateTime.Now;
    }

    private string activeTab = "add";
    private PaymentModel newPayment = new();
    private List<PaymentModel> allPayments = new();
    
    private bool isLoading = false;
    private bool isProcessing = false;
    private bool autoGenerateReference = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadSampleData();
        GenerateReferenceId();
    }

    private async Task LoadSampleData()
    {
        isLoading = true;
        try
        {
            var payments = await Db.Payments.AsNoTracking().ToListAsync();
            allPayments = payments.Select(p => new PaymentModel
            {
                Id = p.Id.ToString(),
                CustomerName = p.CustomerName,
                PaymentDate = p.PaymentDate ?? DateTime.Today,
                Amount = p.Amount ?? 0,
                PaymentMethod = p.PaymentMethod,
                Status = p.Status,
                ReferenceId = p.ReferenceId,
                Description = p.Description,
                CreatedAt = p.CreatedAt ?? DateTime.Now
            }).ToList();
        }
        catch
        {
            allPayments = new List<PaymentModel>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        if (tab == "add")
        {
            GenerateReferenceId();
        }
    }

    private void GenerateReferenceId()
    {
        if (autoGenerateReference)
        {
            var nextNumber = allPayments.Count + 1;
            newPayment.ReferenceId = $"PAY-2024-{nextNumber:D3}";
        }
    }

    private async Task ProcessPayment()
    {
        isProcessing = true;
        try
        {
            newPayment.CreatedAt = DateTime.Now;
            allPayments.Add(new PaymentModel
            {
                Id = newPayment.Id,
                CustomerName = newPayment.CustomerName,
                PaymentDate = newPayment.PaymentDate,
                Amount = newPayment.Amount,
                PaymentMethod = newPayment.PaymentMethod,
                Status = newPayment.Status,
                ReferenceId = newPayment.ReferenceId,
                Description = newPayment.Description,
                CreatedAt = newPayment.CreatedAt
            });

            // persist
            try
            {
                var entity = new FinanceSystem1.Data.Payment
                {
                    Id = Guid.Parse(newPayment.Id),
                    CustomerName = newPayment.CustomerName,
                    PaymentDate = newPayment.PaymentDate,
                    Amount = newPayment.Amount,
                    PaymentMethod = newPayment.PaymentMethod,
                    Status = newPayment.Status,
                    ReferenceId = newPayment.ReferenceId,
                    Description = newPayment.Description,
                    CreatedAt = newPayment.CreatedAt
                };
                Db.Payments.Add(entity);
                await Db.SaveChangesAsync();
            }
            catch
            {
                // ignore DB errors
            }

            ClearForm();
            SetActiveTab("view");
            await Task.Delay(100);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ClearForm()
    {
        newPayment = new PaymentModel { PaymentDate = DateTime.Today };
        GenerateReferenceId();
    }

    private string GetRowClass(string status)
    {
        return status.ToLower() switch
        {
            "completed" => "completed",
            "pending" => "pending",
            "failed" => "failed",
            _ => ""
        };
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "completed" => "status-completed",
            "pending" => "status-pending",
            "failed" => "status-failed",
            _ => ""
        };
    }

    private void ViewPaymentDetails(PaymentModel payment)
    {
        Console.WriteLine($"Viewing comprehensive details for payment: {payment.ReferenceId}");
        
        // Show detailed payment information
        var details = new {
            Payment = payment,
            BasicInfo = new {
                ReferenceId = payment.ReferenceId,
                CustomerName = payment.CustomerName,
                Amount = payment.Amount.ToString("C"),
                PaymentDate = payment.PaymentDate.ToString("MMM dd, yyyy"),
                Status = payment.Status
            },
            PaymentDetails = new {
                PaymentMethod = payment.PaymentMethod,
                ProcessingFee = CalculateProcessingFee(payment.Amount, payment.PaymentMethod).ToString("C"),
                NetAmount = (payment.Amount - CalculateProcessingFee(payment.Amount, payment.PaymentMethod)).ToString("C"),
                Currency = "USD"
            },
            ProcessingInfo = new {
                CreatedAt = payment.CreatedAt.ToString("MMM dd, yyyy HH:mm"),
                ProcessedAt = payment.Status == "Completed" ? payment.CreatedAt.AddMinutes(5).ToString("MMM dd, yyyy HH:mm") : "Pending",
                ProcessingTime = payment.Status == "Completed" ? "5 minutes" : "Pending",
                Description = payment.Description
            },
            VerificationInfo = new {
                TransactionId = GenerateTransactionId(payment.ReferenceId),
                BankReference = payment.PaymentMethod == "Bank Transfer" ? GenerateBankReference() : "N/A",
                AuthorizationCode = payment.PaymentMethod == "Credit Card" ? GenerateAuthCode() : "N/A"
            },
            AuditTrail = new[] {
                new { Timestamp = payment.CreatedAt, Action = "Payment Initiated", User = payment.CustomerName, Details = $"Payment of {payment.Amount:C} initiated" },
                new { Timestamp = payment.CreatedAt.AddMinutes(1), Action = "Validation", User = "System", Details = "Payment details validated" },
                new { Timestamp = payment.CreatedAt.AddMinutes(2), Action = "Processing", User = "Payment Gateway", Details = "Payment submitted for processing" },
                new { Timestamp = payment.CreatedAt.AddMinutes(5), Action = "Completion", User = "System", Details = payment.Status == "Completed" ? "Payment completed successfully" : $"Payment status: {payment.Status}" }
            }
        };
        
        Console.WriteLine($"Payment Details: {System.Text.Json.JsonSerializer.Serialize(details, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}");
    }

    private void EditPayment(PaymentModel payment)
    {
        Console.WriteLine($"Editing payment: {payment.ReferenceId}");
        
        // Pre-populate the payment form with existing data for editing
        newPayment = new PaymentModel
        {
            Id = payment.Id,
            CustomerName = payment.CustomerName,
            PaymentDate = payment.PaymentDate,
            Amount = payment.Amount,
            PaymentMethod = payment.PaymentMethod,
            Status = payment.Status,
            ReferenceId = payment.ReferenceId,
            Description = payment.Description,
            CreatedAt = payment.CreatedAt
        };
        
        autoGenerateReference = false;
        SetActiveTab("add");
    }

    private void ArchivePayment(PaymentModel payment)
    {
        Console.WriteLine($"Archiving payment: {payment.ReferenceId}");
        
        // Archive the payment instead of deleting
        var archiveReason = "Payment archived by administrator";
        var archiveData = new {
            ReferenceId = payment.ReferenceId,
            CustomerName = payment.CustomerName,
            Amount = payment.Amount,
            PaymentMethod = payment.PaymentMethod,
            Status = payment.Status,
            ArchivedDate = DateTime.Now,
            ArchivedBy = "Admin User",
            ArchiveReason = archiveReason,
            OriginalData = payment
        };
        
        Console.WriteLine($"Archive Data: {System.Text.Json.JsonSerializer.Serialize(archiveData, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}");
        
        // Remove from active payments list
        allPayments.Remove(payment);
        
        try
        {
            var entity = Db.Payments.FirstOrDefault(e => e.Id.ToString() == payment.Id);
            if (entity != null)
            {
                // Instead of removing, mark as archived
                entity.Description = $"ARCHIVED on {DateTime.Now:yyyy-MM-dd} - {archiveReason}\n{entity.Description}";
                entity.Status = "Archived";
                Db.SaveChanges();
            }
        }
        catch
        {
            // ignore DB errors but continue with UI update
        }
        
        StateHasChanged();
    }

    // Helper methods for payment calculations
    private decimal CalculateProcessingFee(decimal amount, string paymentMethod)
    {
        return paymentMethod switch
        {
            "Credit Card" => amount * 0.029m, // 2.9% processing fee
            "Bank Transfer" => Math.Min(amount * 0.01m, 10m), // 1% up to $10
            "Cash" => 0m,
            _ => 0m
        };
    }
    
    private string GenerateTransactionId(string referenceId)
    {
        return $"TXN-{referenceId}-{DateTime.Now:yyyyMMdd}-{new Random().Next(1000, 9999)}";
    }
    
    private string GenerateBankReference()
    {
        return $"BNK-{DateTime.Now:yyyyMMdd}-{new Random().Next(100000, 999999)}";
    }
    
    private string GenerateAuthCode()
    {
        return $"AUTH-{new Random().Next(100000, 999999)}";
    }
}