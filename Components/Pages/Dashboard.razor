@page "/dashboard"
@using Microsoft.EntityFrameworkCore
@using FinanceSystem1.Data
@inject FinanceSystem1.Data.AppDbContext Db

<PageTitle>Fortress Finance Dashboard</PageTitle>

<div class="dashboard-header">
    <h1>Fortress Finance Dashboard</h1>
    <div class="user-info">
        <div class="user-avatar">A</div>
        <div class="user-details">
            <div class="user-name">Admin User</div>
            <div class="user-role">Administrator</div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(dbErrorMessage))
{
    <div class="db-error-banner">
        <div class="error-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
        </div>
        <div class="error-content">
            <strong>Database Connection Issue</strong>
            <p>@dbErrorMessage</p>
            <button class="btn btn-primary btn-sm" @onclick="RefreshData">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23,4 23,10 17,10"/>
                    <polyline points="1,20 1,14 7,14"/>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                </svg>
                Retry Connection
            </button>
        </div>
    </div>
}

<div class="dashboard-container">
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading dashboard data...</p>
        </div>
    }
    else
    {
        <!-- KPI Cards -->
        <div class="kpi-section">
            <div class="kpi-card total-revenue">
                <div class="kpi-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                    </svg>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">TOTAL REVENUE</div>
                    <div class="kpi-value">$@totalRevenue.ToString("N0")</div>
                    <div class="kpi-trend">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                        </svg>
                        @monthlyGrowth.ToString("N1")% growth
                    </div>
                </div>
            </div>
            
            <div class="kpi-card active-loans">
                <div class="kpi-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">ACTIVE LOANS</div>
                    <div class="kpi-value">@activeLoanCount</div>
                    <div class="kpi-trend">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9,11 12,14 22,4"/>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                        </svg>
                        @newLoansThisMonth new this month
                    </div>
                </div>
            </div>
            
            <div class="kpi-card overdue-accounts">
                <div class="kpi-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">OVERDUE ACCOUNTS</div>
                    <div class="kpi-value">@overdueAccountCount</div>
                    <div class="kpi-trend">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        $@overdueAmount.ToString("N0") overdue
                    </div>
                </div>
            </div>
            
            <div class="kpi-card total-customers">
                <div class="kpi-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">TOTAL CUSTOMERS</div>
                    <div class="kpi-value">@totalCustomers</div>
                    <div class="kpi-trend">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="8,12 12,16 16,12"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                        </svg>
                        @newCustomersThisMonth new this month
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-container revenue-trend">
                <div class="chart-header">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                        Revenue Trend
                    </h3>
                    <select class="time-selector" @onchange="OnTimePeriodChanged">
                        <option value="month">This Month</option>
                        <option value="lastMonth">Last Month</option>
                        <option value="quarter">Last 3 Months</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                <div class="revenue-chart-data">
                    <div class="revenue-summary">
                        <div class="summary-item">
                            <span class="summary-label">Total Revenue</span>
                            <span class="summary-value">$@filteredRevenue.ToString("N0")</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Interest Earned</span>
                            <span class="summary-value">$@totalInterestEarned.ToString("N0")</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Average Loan</span>
                            <span class="summary-value">$@averageLoanAmount.ToString("N0")</span>
                        </div>
                    </div>
                    @if (revenueDataList.Any())
                    {
                        <div class="revenue-list">
                            @foreach (var revenue in revenueDataList.Take(5))
                            {
                                <div class="revenue-item">
                                    <div class="revenue-info">
                                        <span class="customer-name">@revenue.CustomerName</span>
                                        <span class="loan-amount">$@revenue.LoanAmount?.ToString("N0")</span>
                                    </div>
                                    <div class="revenue-details">
                                        <span class="status @GetStatusClass(revenue.Status)">@revenue.Status</span>
                                        <span class="interest-rate">@revenue.InterestRate?.ToString("N1")%</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="chart-placeholder">
                            <div class="placeholder-content">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                                </svg>
                                <p>No revenue data available for the selected period</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
            
            <div class="chart-container collection-rate">
                <div class="chart-header">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22,4 12,14.01 9,11.01"/>
                        </svg>
                        Collection Rate
                    </h3>
                    <select class="time-selector" @onchange="OnCollectionPeriodChanged">
                        <option value="month">This Month</option>
                        <option value="lastMonth">Last Month</option>
                        <option value="quarter">Last 3 Months</option>
                    </select>
                </div>
                <div class="circular-chart">
                    <div class="chart-circle" style="background: conic-gradient(#4fc3f7 0deg @((double)collectionRate * 3.6)deg, #e0e0e0 @((double)collectionRate * 3.6)deg 360deg);">
                        <div class="percentage">@collectionRate.ToString("N0")%</div>
                    </div>
                    <div class="chart-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                        On-time Payments
                    </div>
                </div>
                <div class="completion-stats">
                    <div class="stat">
                        <span class="label">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20,6 9,17 4,12"/>
                            </svg>
                            COMPLETED
                        </span>
                        <span class="value">@completedPayments</span>
                    </div>
                    <div class="stat">
                        <span class="label">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            TOTAL
                        </span>
                        <span class="value">@totalPayments</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity and Key Metrics -->
        <div class="bottom-section">
            <div class="recent-activity">
                <div class="chart-header">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                        Recent Activity
                    </h3>
                    <div class="subtitle">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                        </svg>
                        Latest transactions and applications
                    </div>
                </div>
                <div class="activity-content">
                    @if (recentPayments.Any() || recentApplications.Any())
                    {
                        <div class="activity-tabs">
                            <button class="tab-btn @(activeTab == "payments" ? "active" : "")" @onclick='() => SetActiveTab("payments")'>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                    <line x1="1" y1="10" x2="23" y2="10"/>
                                </svg>
                                Recent Payments
                            </button>
                            <button class="tab-btn @(activeTab == "applications" ? "active" : "")" @onclick='() => SetActiveTab("applications")'>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14,2 14,8 20,8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10,9 9,9 8,9"/>
                                </svg>
                                New Applications
                            </button>
                        </div>
                        
                        @if (activeTab == "payments")
                        {
                            <div class="activity-list">
                                @foreach (var payment in recentPayments.Take(5))
                                {
                                    <div class="activity-item payment-item">
                                        <div class="activity-icon payment-icon">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                                <line x1="1" y1="10" x2="23" y2="10"/>
                                            </svg>
                                        </div>
                                        <div class="activity-details">
                                            <div class="activity-primary">@payment.CustomerName</div>
                                            <div class="activity-secondary">@payment.Description</div>
                                            <div class="activity-time">@payment.PaymentDate?.ToString("MMM dd, HH:mm")</div>
                                        </div>
                                        <div class="activity-amount @GetPaymentStatusClass(payment.Status)">
                                            <div class="amount">$@payment.Amount?.ToString("N0")</div>
                                            <div class="status">@payment.Status</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="activity-list">
                                @foreach (var application in recentApplications.Take(5))
                                {
                                    <div class="activity-item application-item">
                                        <div class="activity-icon application-icon">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                                <polyline points="14,2 14,8 20,8"/>
                                                <line x1="16" y1="13" x2="8" y2="13"/>
                                                <line x1="16" y1="17" x2="8" y2="17"/>
                                                <polyline points="10,9 9,9 8,9"/>
                                            </svg>
                                        </div>
                                        <div class="activity-details">
                                            <div class="activity-primary">@application.ApplicantName</div>
                                            <div class="activity-secondary">@application.Purpose</div>
                                            <div class="activity-time">@application.ApplicationDate?.ToString("MMM dd, HH:mm")</div>
                                        </div>
                                        <div class="activity-amount">
                                            <div class="amount">$@application.Amount?.ToString("N0")</div>
                                            <div class="status @GetApplicationStatusClass(application.Status)">@application.Status</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="chart-placeholder">
                            <div class="placeholder-content">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="20" x2="18" y2="10"/>
                                    <line x1="12" y1="20" x2="12" y2="4"/>
                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                </svg>
                                <p>No recent activity to display</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
            
            <div class="key-metrics">
                <div class="chart-header">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                        </svg>
                        Key Metrics
                    </h3>
                    <div class="subtitle">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                        Summary statistics
                    </div>
                </div>
                <div class="metrics-content">
                    <div class="metric-item">
                        <span class="metric-label">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                            </svg>
                            Average Loan Amount
                        </span>
                        <span class="metric-value">$@averageLoanAmount.ToString("N0")</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="13,2 3,14 12,14 11,22 21,10 12,10 13,2"/>
                            </svg>
                            Collection Efficiency
                        </span>
                        <span class="metric-value">@collectionRate.ToString("N1")%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <line x1="19" y1="8" x2="19" y2="14"/>
                                <line x1="22" y1="11" x2="16" y2="11"/>
                            </svg>
                            New Customers (Month)
                        </span>
                        <span class="metric-value">@newCustomersThisMonth</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                            Default Rate
                        </span>
                        <span class="metric-value">@defaultRate.ToString("N1")%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12,6 12,12 16,14"/>
                            </svg>
                            Avg Processing Time
                        </span>
                        <span class="metric-value">@averageProcessingTime.ToString("N0") days</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                            </svg>
                            Monthly Growth
                        </span>
                        <span class="metric-value">@monthlyGrowth.ToString("N1")%</span>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    // Data properties
    private bool isLoading = true;
    private string dbErrorMessage = string.Empty;
    private string selectedTimePeriod = "month";
    private string selectedCollectionPeriod = "month";
    private string activeTab = "payments";

    // Dashboard KPI data
    private decimal totalRevenue = 0;
    private decimal filteredRevenue = 0;
    private decimal totalInterestEarned = 0;
    private int activeLoanCount = 0;
    private int overdueAccountCount = 0;
    private decimal overdueAmount = 0;
    private int totalCustomers = 0;
    private int newCustomersThisMonth = 0;
    private int newLoansThisMonth = 0;
    private decimal averageLoanAmount = 0;
    private decimal collectionRate = 0;
    private int completedPayments = 0;
    private int totalPayments = 0;
    private decimal defaultRate = 0;
    private decimal averageProcessingTime = 0;
    private decimal monthlyGrowth = 0;

    // Data collections
    private List<RevenueData> revenueDataList = new();
    private List<FinanceSystem1.Data.Payment> recentPayments = new();
    private List<LoanApplication> recentApplications = new();
    private List<FinanceSystem1.Data.Customer> customersList = new();
    private List<OverdueAccount> overdueAccountsList = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        dbErrorMessage = string.Empty;
        StateHasChanged();

        try
        {
            Console.WriteLine("Loading dashboard data...");
            
            // Test database connectivity
            var canConnect = await TestDatabaseConnection();
            if (!canConnect)
            {
                Console.WriteLine("Database connection failed");
                return;
            }

            // Load all data sequentially to avoid DbContext threading issues
            Console.WriteLine("Loading revenue data...");
            await LoadRevenueData();
            
            Console.WriteLine("Loading customer data...");
            await LoadCustomerData();
            
            Console.WriteLine("Loading loan data...");
            await LoadLoanData();
            
            Console.WriteLine("Loading payment data...");
            await LoadPaymentData();
            
            Console.WriteLine("Loading overdue data...");
            await LoadOverdueData();
            
            // Calculate KPIs after all data is loaded
            Console.WriteLine("Calculating KPIs...");
            CalculateKPIs();
            
            Console.WriteLine("Dashboard data loaded successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            
            if (ex.InnerException != null)
            {
                Console.WriteLine($"Inner exception: {ex.InnerException.Message}");
            }
            
            dbErrorMessage = $"Failed to load dashboard data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task<bool> TestDatabaseConnection()
    {
        try
        {
            Console.WriteLine("Testing database connection...");
            
            // First test basic connectivity
            var canConnect = await Db.Database.CanConnectAsync();
            if (!canConnect)
            {
                dbErrorMessage = "Cannot connect to database. Please check your connection string and ensure SQL Server is running.";
                Console.WriteLine("Database connectivity test failed");
                return false;
            }
            
            Console.WriteLine("Database connection successful");
            
            // Test if we can query each table individually to catch specific issues
            try
            {
                var customerCount = await Db.Customers.AsNoTracking().CountAsync();
                var userCount = await Db.Users.AsNoTracking().CountAsync();
                Console.WriteLine($"Database verification: {customerCount} customers, {userCount} users");
            }
            catch (Exception tableEx)
            {
                Console.WriteLine($"Table query failed: {tableEx.Message}");
                dbErrorMessage = "Database tables may not exist. Please run the database setup scripts (CleanCreateDatabase.sql and InsertSampleData.sql).";
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Database connection test failed: {ex.Message}");
            dbErrorMessage = $"Database connection error: {ex.Message}. Please ensure SQL Server is running and the connection string is correct.";
            return false;
        }
    }

    private async Task LoadRevenueData()
    {
        try
        {
            revenueDataList = await Db.RevenueDatas
                .AsNoTracking()
                .Where(r => r.Status != null)
                .OrderByDescending(r => r.LoanDate)
                .ToListAsync();
            
            Console.WriteLine($"Loaded {revenueDataList.Count} revenue records");
            
            totalRevenue = revenueDataList.Sum(r => r.PaidAmount ?? 0);
            totalInterestEarned = revenueDataList.Sum(r => r.InterestEarned ?? 0);
            
            // Filter revenue based on selected period
            FilterRevenueByPeriod();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading revenue data: {ex.Message}");
            revenueDataList = new List<RevenueData>();
            totalRevenue = 0;
            totalInterestEarned = 0;
            filteredRevenue = 0;
        }
    }

    private async Task LoadCustomerData()
    {
        try
        {
            customersList = await Db.Customers
                .AsNoTracking()
                .OrderByDescending(c => c.CreatedAt)
                .ToListAsync();
            
            Console.WriteLine($"Loaded {customersList.Count} customer records");
            
            totalCustomers = customersList.Count;
            
            var currentMonth = DateTime.Now.Month;
            var currentYear = DateTime.Now.Year;
            newCustomersThisMonth = customersList
                .Count(c => c.CreatedAt?.Month == currentMonth && c.CreatedAt?.Year == currentYear);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading customer data: {ex.Message}");
            customersList = new List<FinanceSystem1.Data.Customer>();
            totalCustomers = 0;
            newCustomersThisMonth = 0;
        }
    }

    private async Task LoadLoanData()
    {
        try
        {
            var loanApplications = await Db.LoanApplications
                .AsNoTracking()
                .OrderByDescending(l => l.ApplicationDate)
                .ToListAsync();
            
            Console.WriteLine($"Loaded {loanApplications.Count} loan application records");
            
            activeLoanCount = loanApplications.Count(l => l.Status == "Approved" || l.Status == "Active");
            
            var currentMonth = DateTime.Now.Month;
            var currentYear = DateTime.Now.Year;
            newLoansThisMonth = loanApplications
                .Count(l => l.ApplicationDate?.Month == currentMonth && 
                           l.ApplicationDate?.Year == currentYear &&
                           l.Status == "Approved");
            
            if (loanApplications.Any(l => l.Amount.HasValue))
            {
                averageLoanAmount = loanApplications
                    .Where(l => l.Amount.HasValue)
                    .Average(l => l.Amount.Value);
            }

            recentApplications = loanApplications.Take(10).ToList();
            
            // Calculate average processing time
            var processedApps = loanApplications
                .Where(l => l.Status != "Pending" && l.ApplicationDate.HasValue && l.LastUpdated.HasValue)
                .ToList();
            
            if (processedApps.Any())
            {
                averageProcessingTime = (decimal)processedApps
                    .Average(l => (l.LastUpdated.Value - l.ApplicationDate.Value).TotalDays);
            }

            // Calculate default rate
            var totalProcessedLoans = loanApplications.Count(l => l.Status != "Pending");
            var rejectedLoans = loanApplications.Count(l => l.Status == "Rejected");
            defaultRate = totalProcessedLoans > 0 ? (decimal)rejectedLoans / totalProcessedLoans * 100 : 0;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading loan data: {ex.Message}");
            recentApplications = new List<LoanApplication>();
            activeLoanCount = 0;
            newLoansThisMonth = 0;
            averageLoanAmount = 0;
            averageProcessingTime = 0;
            defaultRate = 0;
        }
    }

    private async Task LoadPaymentData()
    {
        try
        {
            var payments = await Db.Payments
                .AsNoTracking()
                .OrderByDescending(p => p.PaymentDate)
                .ToListAsync();
            
            Console.WriteLine($"Loaded {payments.Count} payment records");
            
            totalPayments = payments.Count;
            completedPayments = payments.Count(p => p.Status == "Completed");
            collectionRate = totalPayments > 0 ? (decimal)completedPayments / totalPayments * 100 : 0;
            
            recentPayments = payments.Take(10).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading payment data: {ex.Message}");
            recentPayments = new List<FinanceSystem1.Data.Payment>();
            totalPayments = 0;
            completedPayments = 0;
            collectionRate = 0;
        }
    }

    private async Task LoadOverdueData()
    {
        try
        {
            overdueAccountsList = await Db.OverdueAccounts
                .AsNoTracking()
                .OrderByDescending(o => o.DaysOverdue)
                .ToListAsync();
            
            Console.WriteLine($"Loaded {overdueAccountsList.Count} overdue account records");
            
            overdueAccountCount = overdueAccountsList.Count;
            overdueAmount = overdueAccountsList.Sum(o => o.OutstandingAmount ?? 0);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading overdue data: {ex.Message}");
            overdueAccountsList = new List<OverdueAccount>();
            overdueAccountCount = 0;
            overdueAmount = 0;
        }
    }

    private void CalculateKPIs()
    {
        // Calculate monthly growth
        var currentMonth = DateTime.Now;
        var lastMonth = currentMonth.AddMonths(-1);
        
        var currentMonthRevenue = revenueDataList
            .Where(r => r.LoanDate?.Month == currentMonth.Month && r.LoanDate?.Year == currentMonth.Year)
            .Sum(r => r.PaidAmount ?? 0);
        
        var lastMonthRevenue = revenueDataList
            .Where(r => r.LoanDate?.Month == lastMonth.Month && r.LoanDate?.Year == lastMonth.Year)
            .Sum(r => r.PaidAmount ?? 0);
        
        if (lastMonthRevenue > 0)
        {
            monthlyGrowth = ((currentMonthRevenue - lastMonthRevenue) / lastMonthRevenue) * 100;
        }
    }

    private void FilterRevenueByPeriod()
    {
        var now = DateTime.Now;
        var filterDate = selectedTimePeriod switch
        {
            "month" => now.AddDays(-30),
            "lastMonth" => now.AddDays(-60),
            "quarter" => now.AddDays(-90),
            "year" => now.AddDays(-365),
            _ => now.AddDays(-30)
        };

        var filteredData = revenueDataList
            .Where(r => r.LoanDate >= filterDate)
            .ToList();

        filteredRevenue = filteredData.Sum(r => r.PaidAmount ?? 0);
    }

    private async Task OnTimePeriodChanged(ChangeEventArgs e)
    {
        selectedTimePeriod = e.Value?.ToString() ?? "month";
        FilterRevenueByPeriod();
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task OnCollectionPeriodChanged(ChangeEventArgs e)
    {
        selectedCollectionPeriod = e.Value?.ToString() ?? "month";
        // Recalculate collection rate based on selected period
        // Implementation would filter payments by period
        StateHasChanged();
        await Task.CompletedTask;
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    private async Task RefreshData()
    {
        await LoadDashboardData();
    }

    // Helper methods for CSS classes
    private string GetStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "active" => "status-active",
            "completed" => "status-completed",
            "pending" => "status-pending",
            "rejected" => "status-rejected",
            _ => "status-default"
        };
    }

    private string GetPaymentStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "completed" => "payment-completed",
            "pending" => "payment-pending",
            "failed" => "payment-failed",
            _ => "payment-default"
        };
    }

    private string GetApplicationStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "approved" => "app-approved",
            "pending" => "app-pending",
            "rejected" => "app-rejected",
            "under review" => "app-review",
            _ => "app-default"
        };
    }
}